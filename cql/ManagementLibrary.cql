/*
  Library: Management of Abnormal Cervical Cancer Screening Results
  Author: CMS Alliance to Modernize Healthcare, operated by THE MITRE Corporation.

  (C) 2021 The MITRE Corporation. All Rights Reserved.
  Approved for Public Release: 21-1556.
  Distribution Unlimited.

  Unless otherwise noted, this work is available under an Apache 2.0 license.
  It was produced by the MITRE Corporation for the Division of Cancer Prevention
  and Control, Centers for Disease Control and Prevention in accordance with the
  Statement of Work, contract number 75FCMC18D0047, task order number 75D30120F09743.
*/

library ManagementLibrary version '1.0.0'

using FHIR version '4.0.1'

include CDSConnectCommonsforFHIRv401 version '1.0.0' called C3F
include FHIRHelpers version '4.0.1' called FHIRHelpers
include DisplayCervicalCancerMedicalHistory version '1.0.0' called Dash
include CCSMCommonFunctions version '1.0.0' called Common
include TopLevelScreeningLibrary version '1.0.0' called Entry
include ScreeningSymptomaticLibrary version '1.0.0' called Symptomatic
include ScreeningAverageRiskLibrary version '1.0.0' called L4
include AutogeneratedTableLookup version '1.0.0' called RiskTableLookup

//------------------------------------------------------------------------------
// CODE SYSTEMS, VALUE SETS, AND CODES
//------------------------------------------------------------------------------

codesystem "LOINC": 'http://loinc.org'
codesystem "SNOMED-CT": 'http://snomed.info/sct'
codesystem "ICD-9": 'http://hl7.org/fhir/sid/icd-9-cm'
codesystem "ICD-10": 'http://hl7.org/fhir/sid/icd-10-cm'
codesystem "NULL FLAVOR": 'http://terminology.hl7.org/CodeSystem/v3-NullFlavor'
codesystem "LOCAL": 'http://OUR-PLACEHOLDER-URL.com'

valueset "Premenopausal": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113762.1.4.1032.254' // AKA: Premenopausal
valueset "All Results of High Risk HPV Test": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113762.1.4.1032.233' // NOTE: This value set should be expanded to include DNA findings of HPV 16 and HPV 18 (and potentially RNA findings).
valueset "HSIL": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113762.1.4.1032.256'

code "ASC-H": '441088002' from "SNOMED-CT" display 'Atypical squamous cells on cervical Papanicolaou smear cannot exclude high grade squamous intraepithelial lesion (finding)'
code "CIN1": '285836003' from "SNOMED-CT" display 'Cervical intraepithelial neoplasia grade 1 (disorder)'

code "Atypical Endometrial Cells": '103646000' from "SNOMED-CT" display 'Atypical endometrial cells of undetermined significance (morphologic abnormality)'
code "Atypical Endocervical Cells":	'441094005' from "SNOMED-CT" display 'Atypical endocervical cells on cervical Papanicolaou smear (finding)'
code "Endocervical AIS": '447760009' from "SNOMED-CT" display 'Endocervical adenocarcinoma in situ (disorder)'
code "AGC": '441219009' from "SNOMED-CT" display 'Atypical glandular cells on cervical Papanicolaou smear (finding)'
code "AGC Favor Neoplasia": '373883009' from "SNOMED-CT" display 'Atypical glandular cells, favor neoplastic (morphologic abnormality)'
code "Endocervical Cells Favor Neoplasia": '373882004' from "SNOMED-CT" display 'Atypical endocervical cells, favor neoplastic (morphologic abnormality)'
code "Unsatisfactory": '126481000119106' from "SNOMED-CT" display 'Vaginal Papanicolaou smear unsatisfactory for evaluation (finding)'
code "Absent Transformation Zone": '412716005' from "SNOMED-CT" display 'Cervical smear transformation zone cells absent (situation)'
code "Benign Endometrial Cells": '125155008' from "SNOMED-CT" display 'Endometrial cells, cytologically benign, in a postmenopausal woman (finding)'
code "Premenopausal Menorrhagia": '627.0' from "ICD-9" display 'Premenopausal menorrhagia' // AKA: Premenopausal
code "Excessive Bleeding in the Premenopausal Period": 'N92.4' from "ICD-10" display 'Excessive bleeding in the premenopausal period' // AKA: Premenopausal
code "Postmenopausal": '76498008' from "SNOMED-CT" display 'Postmenopausal state (finding)'
code "Histiocytes": '14295007' from "SNOMED-CT" display 'Resident tissue macrophage (cell)'
code "Unknown": 'UNK' from "NULL FLAVOR" display 'Unknown'

code "HPV16+ Antigen": '766842008' from "SNOMED-CT" display 'Antigen of Human papillomavirus type 16 L1 capsid protein (substance)' // NOTE: We still need to determine whether HPV16+ will become a value set
code "HPV16+ DNA": '708298003' from "SNOMED-CT" display 'Deoxyribonucleic acid of Human papillomavirus 16 (substance)'
code "HPV18+ Antigen": '766848007' from "SNOMED-CT" display 'Antigen of Human papillomavirus type 18 L1 capsid protein (substance)' // NOTE: We still need to determine whether HPV18+ will become a value set
code "HPV18+ DNA": '708299006' from "SNOMED-CT" display 'Deoxyribonucleic acid of Human papillomavirus 18 (substance)'
code "Biopsy Normal": '165324008' from "SNOMED-CT" display 'Biopsy result normal (finding)'

code "LSIL": '62051000119105' from "SNOMED-CT" display 'Low grade squamous intraepithelial lesion on cervical Papanicolaou smear (finding)'
code "ASC-US": '441087007' from "SNOMED-CT" display 'Atypical squamous cells of undetermined significance on cervical Papanicolaou smear (finding)'

// Local codes
code "Benign Glandular Cells": 'BGC' from "LOCAL" display 'Benign Glandular Cells'
code "Endometrial Stromal Cells": 'ESC' from "LOCAL" display 'Endometrial stromal cells'

//------------------------------------------------------------------------------
// PARAMETERS
//------------------------------------------------------------------------------

parameter BiopsyLookbackPeriod default 25 years
parameter BiopsyReferralPeriod default 1 month
parameter ExcludeSymptomatic default true
parameter HpvTestingGracePeriod default 6 months

/***** BEGIN CDS LOGIC ********************************************************/

context Patient

//------------------------------------------------------------------------------
// FUNCTIONS
//------------------------------------------------------------------------------

define function HPVTestingIntervalLookBack(LookBackDate System.DateTime):
  Interval[LookBackDate - HpvTestingInterval, LookBackDate)

define function GetEarlierDate(d1 System.DateTime, d2 System.DateTime):
  if d1 is not null then
    if d2 is not null then
      if d1 same or before d2 then d1
      else d2
    else d1
  else
    if d2 is not null then d2
    else null

define function CytologyInterpretation(conclusions List<System.Concept>):
  if conclusions is not null then
    (conclusions) c
    return
      case
        when c ~ Dash."NILM" then {text: 'NILM', rank: 1}
        when c ~ "ASC-US" then {text: 'ASC-US', rank: 2}
        when c ~ "LSIL" then {text: 'LSIL', rank: 3}
        when c ~ "ASC-H" then {text: 'ASC-H', rank: 4}
        when c ~ "AGC" then {text: 'AGC', rank: 5}
        when c in "HSIL" then {text: 'HSIL+', rank: 6}
        else {text: 'ALL', rank: 0}
      end
  else
    {{text: 'ALL', rank: 0}}

/**
 * Takes a list of HPV conclusion codes and maps each to a text value and a numerical
 * ranking. The text value can be used as input to the risk tables and the numerical
 * ranking is meant to convey precendence so that the most specific conclusion can
 * be selected from amongst a group of codes. For instance, an HPV test may come back
 * both as postive and postive for HPV16. We want to be able to select the latter
 * in this case as input to the risk tables.
 * @param conclusions - a list of CodeableConcepts
 * @returns List<Tuple { text System.String, rank System.Integer }>
 */
define function HpvInterpretation(conclusions List<System.Concept>):
  (conclusions) c
  return
    case
      when c ~ Dash."Negative HPV Finding" or c ~ Dash."Negative" then {text: 'HPV-negative', rank: 1}
      when c ~ Dash."Positive HPV Finding" then {text: 'HPV-positive', rank: 2}
      when c ~ "HPV18+ Antigen" or c ~ "HPV18+ DNA" then {text: 'HPV16-, HPV18+', rank: 3}
      when c ~ "HPV16+ Antigen" or c ~ "HPV16+ DNA" then {text: 'HPV16+', rank: 4}
      else {text: 'ALL', rank: 0}
    end

/**
 * Takes the output from HpvInterpretation() and returns the text of the
 * interpretation with the highest rank. This allows more specific conclusions to
 * take precedence over more general ones.
 * @param interpretations - a list of tuples
 * @returns System.String the text to be used as input to the risk tables
 */
define function HighestRankedInterpretation(interpretations List<Tuple { text System.String, rank System.Integer }>):
  Last(
    (
      (interpretations) I sort by rank
    ) S
    return S.text
  )

define function BiopsyInterpretation(conclusions List<System.Concept>):
  (conclusions) c
  return
    case
      when c ~ "Biopsy Normal" then {text: '<CIN1', rank: 1}
      when c ~ "CIN1" then {text: 'CIN1', rank: 2}
      when c ~ Dash."CIN2" then {text: 'CIN2', rank: 3}
      when c ~ Dash."CIN3" then {text: 'CIN3', rank: 4}
      when c in Dash."AIS" then {text: 'AIS', rank: 5}
      when c in Dash."Histologic cancer" then {text: 'Cancer', rank: 6}
      else {text: 'ALL', rank: 0}
    end

//------------------------------------------------------------------------------
// INCLUSIONS
//------------------------------------------------------------------------------
// Sex at birth = Female
//   OR Gender identity = Transgender Male
// AND
//   INCLUSION #1: Abnormal cervical cancer screening test within the last 7 years
//       hrHPV result = "Positive"
//       OR Cervical Cytology result not equal to "NILM"
//       OR Cervical Histology result not equal to "Negative"
//       <= 7 years ago
//   OR INCLUSION #2: Includes women who have been "diagnosed" with a high-grade precancerous lesion or cervical cancer
//       Diagnosis of High grade pre-cancerous cervical lesion
//       OR Diagnosis of Cervical cancer
//       OR Cervical histology result = "Histologic HSIL (CIN2)" or "Histologic HSIL (CIN3)" or “Histologic HSIL, unspecified” or "Histologic AIS" or "Histologic cancer"

define HasRecentAbnormalScreening:
  Dash.HasRecentAbnormalScreening

define HasHighGradePreCancerCervicalLesion:
  Exists(Dash.CervicalPrecancerDisorders)

define HasCervicalCancerDiagnoses:
  Exists(Dash.CervicalCancerDiagnoses)

define IsIncluded:
  Entry.FemaleorTransgenderMale and
  (
    HasRecentAbnormalScreening or
    HasHighGradePreCancerCervicalLesion or
    HasCervicalCancerDiagnoses or
    Exists(Dash.HighGradeOrCancerHistologyResults)
  )

//------------------------------------------------------------------------------
// EXCLUSIONS
//------------------------------------------------------------------------------
// None
// Upon more detailed review of 2012 ASCCP Management Guidelines, may modify exclusion criteria

define Excluded:
  if ExcludeSymptomatic then
    Symptomatic.IsSymptomatic
  else
    false

//------------------------------------------------------------------------------
// CDS ACTIONS
//------------------------------------------------------------------------------

define IsIncludedAndNotExcluded:
  IsIncluded and not Excluded

//------------------------------------------------------------------------------
// DATA RETRIEVAL
//------------------------------------------------------------------------------

/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
// HPV TESTS

define HpvReports:
  Dash.HpvDiagnosticReports

define SortedHpvReports:
  (HpvReports) H
  return {
    riskTableInput: HighestRankedInterpretation(
      HpvInterpretation(
        H.conclusionCode
      )
    ),
    allConclusions: H.conclusionCode,
    date: Common.DiagnosticReportDate(H)
  }
  sort by date desc

define HpvTestingInterval:
  5 years + HpvTestingGracePeriod

define MostRecentHpvReport:
  if Count(SortedHpvReports) > 0 then
    if SortedHpvReports[0].date included in HPVTestingIntervalLookBack(Today()) then
      SortedHpvReports[0]
    else
      null
  else
    null

define SecondMostRecentHpvReport:
  if Count(SortedHpvReports) > 1 then
    if SortedHpvReports[1].date included in HPVTestingIntervalLookBack(MostRecentHpvReport.date) then
      SortedHpvReports[1]
    else
      null
  else
    null

define ThirdMostRecentHpvReport:
  if Count(SortedHpvReports) > 2 then
    if SortedHpvReports[2].date included in HPVTestingIntervalLookBack(SecondMostRecentHpvReport.date) then
      SortedHpvReports[2]
    else
      null
  else
    null

define FourthMostRecentHpvReport:
  if Count(SortedHpvReports) > 3 then
    if SortedHpvReports[3].date included in HPVTestingIntervalLookBack(ThirdMostRecentHpvReport.date) then
      SortedHpvReports[3]
    else
      null
  else
    null

define MostRecentHpvResult:
  MostRecentHpvReport.riskTableInput

define SecondMostRecentHpvResult:
  SecondMostRecentHpvReport.riskTableInput

define ThirdMostRecentHpvResult:
  ThirdMostRecentHpvReport.riskTableInput

define FourthMostRecentHpvResult:
  FourthMostRecentHpvReport.riskTableInput

/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
// CERVICAL CYTOLOGY

define CervicalCytologyReports:
  Dash.CervicalCytologyReports

define SortedCytologyReports:
  (CervicalCytologyReports) C
  return {
    riskTableInput: HighestRankedInterpretation(
      CytologyInterpretation(
        C.conclusionCode
      )
    ),
    allConclusions: C.conclusionCode,
    date: Common.DiagnosticReportDate(C)
  }
  sort by date desc

// Edge Cases:
// DONE: 1. HPV but no cytology (solution: just use HPV)
// TODO: 2. Cytology but no HPV (no solution: display error)
// NOTE: This is being updated based on "gaps" document

define MostRecentCytologyCotest:
  Coalesce(
    (SortedCytologyReports) S
      where S.date within 1 day of MostRecentHpvReport.date
  )

define SecondMostRecentCytologyCotest:
  Coalesce(
    (SortedCytologyReports) S
      where S.date within 1 day of SecondMostRecentHpvReport.date
  )

define ThirdMostRecentCytologyCotest:
  Coalesce(
    (SortedCytologyReports) S
      where S.date within 1 day of ThirdMostRecentHpvReport.date
  )

define FourthMostRecentCytologyCotest:
  Coalesce(
    (SortedCytologyReports) S
      where S.date within 1 day of FourthMostRecentHpvReport.date
  )

define MostRecentCytologyCotestResult:
  if MostRecentHpvReport is null then
    null
  else
    if MostRecentCytologyCotest is null then
      'ALL'
    else
      MostRecentCytologyCotest.riskTableInput

define SecondMostRecentCytologyCotestResult:
  if SecondMostRecentHpvReport is null then
    null
  else
    if SecondMostRecentCytologyCotest is null then
      'ALL'
    else
      SecondMostRecentCytologyCotest.riskTableInput

define ThirdMostRecentCytologyCotestResult:
  if ThirdMostRecentHpvReport is null then
    null
  else
    if ThirdMostRecentCytologyCotest is null then
      'ALL'
    else
      ThirdMostRecentCytologyCotest.riskTableInput

define FourthMostRecentCytologyCotestResult:
  if FourthMostRecentHpvReport is null then
    null
  else
    if FourthMostRecentCytologyCotest is null then
      'ALL'
    else
      FourthMostRecentCytologyCotest.riskTableInput

/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
// BIOPSIES / HISTOLOGY

define BiopsyReports:
  Common.LookBack(
    Dash.HistologyDiagnosticReports,
    BiopsyLookbackPeriod
  )

define SortedBiopsyReports:
  (BiopsyReports) B
  return {
    riskTableInput: HighestRankedInterpretation(
      BiopsyInterpretation(
        B.conclusionCode
      )
    ),
    allConclusions: B.conclusionCode,
    date: Common.DiagnosticReportDate(B)
  }
  sort by date desc

define MostRecentBiopsyReport:
  if Count(SortedBiopsyReports) > 0 then
      SortedBiopsyReports[0]
  else
    null

define MostRecentBiopsyResult:
  MostRecentBiopsyReport.riskTableInput

define MostRecentBiopsyReferralPeriod:
  Interval[MostRecentBiopsyReport.date - BiopsyReferralPeriod, MostRecentBiopsyReport.date)

define ReferringHpvResult:
  if MostRecentHpvReport.date included in MostRecentBiopsyReferralPeriod then
    MostRecentHpvResult
  else if SecondMostRecentHpvReport.date included in MostRecentBiopsyReferralPeriod then
    SecondMostRecentHpvResult
  else if ThirdMostRecentHpvReport.date included in MostRecentBiopsyReferralPeriod then
    ThirdMostRecentHpvResult
  else if FourthMostRecentHpvReport.date included in MostRecentBiopsyReferralPeriod then
    FourthMostRecentHpvResult
  else
    'ALL'

define MostRecentCytologyBeforeBiopsy:
  Coalesce(
    (SortedCytologyReports) S
      where S.date included in MostRecentBiopsyReferralPeriod
  )

define MostRecentCytologyResultBeforeBiopsy:
  MostRecentCytologyBeforeBiopsy.riskTableInput

define ReferringCytologyResult:
  if MostRecentCytologyCotest.date included in MostRecentBiopsyReferralPeriod then
    MostRecentCytologyCotestResult
  else if SecondMostRecentCytologyCotest.date included in MostRecentBiopsyReferralPeriod then
    SecondMostRecentCytologyCotestResult
  else if ThirdMostRecentCytologyCotest.date included in MostRecentBiopsyReferralPeriod then
    ThirdMostRecentCytologyCotestResult
  else if FourthMostRecentCytologyCotest.date included in MostRecentBiopsyReferralPeriod then
    FourthMostRecentCytologyCotestResult
  else if MostRecentCytologyBeforeBiopsy is not null then
    MostRecentCytologyResultBeforeBiopsy
  else
    'ALL'

define MostRecentHpvResultPostBiopsy:
  if MostRecentHpvReport.date occurs after MostRecentBiopsyReport.date then
    MostRecentHpvResult
  else
    null

define MostRecentCytologyResultPostBiopsy:
  if MostRecentCytologyCotest.date occurs after MostRecentBiopsyReport.date then
    MostRecentCytologyCotestResult
  else
    null

define SecondMostRecentHpvResultPostBiopsy:
  if SecondMostRecentHpvReport.date occurs after MostRecentBiopsyReport.date then
    SecondMostRecentHpvResult
  else
    null

define SecondMostRecentCytologyResultPostBiopsy:
  if SecondMostRecentCytologyCotest.date occurs after MostRecentBiopsyReport.date then
    SecondMostRecentCytologyCotestResult
  else
    null

define ThirdMostRecentHpvResultPostBiopsy:
  if ThirdMostRecentHpvReport.date occurs after MostRecentBiopsyReport.date then
    ThirdMostRecentHpvResult
  else
    null

define ThirdMostRecentCytologyResultPostBiopsy:
  if ThirdMostRecentCytologyCotest.date occurs after MostRecentBiopsyReport.date then
    ThirdMostRecentCytologyCotestResult
  else
    null

/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
// TREATMENTS

// Find CIN2/CIN3 biopsy
define Cin2orCin3Biopsies:
  SortedBiopsyReports S
    where S.riskTableInput in {'CIN2','CIN3'}

define MostRecentCin2orCin3Biopsy:
  First(Cin2orCin3Biopsies)

// Look for treatments after this CIN2/CIN3 biopsy
define CervicalPrecancerTreatments:
  Dash.CervicalExcisionProcedures union
    Dash.CervicalAblationProcedures

define CervicalPrecancerTreatmentsAfterBiopsy:
  CervicalPrecancerTreatments T
    where Common.ProcedureDate(T) occurs after MostRecentCin2orCin3Biopsy.date
    return {
      date: Common.ProcedureDate(T)
    }
    sort by date

define DateOfLastCervicalPrecancerTreatment:
  Last(
    CervicalPrecancerTreatmentsAfterBiopsy
  ).date

// Look for HPV/pap tests after treatment
define MostRecentHpvResultAfterTreatment:
  if MostRecentHpvReport.date occurs after DateOfLastCervicalPrecancerTreatment then
    MostRecentHpvResult
  else
    null

define SecondMostRecentHpvResultAfterTreatment:
  if SecondMostRecentHpvReport.date occurs after DateOfLastCervicalPrecancerTreatment then
    SecondMostRecentHpvResult
  else
    null

define ThirdMostRecentHpvResultAfterTreatment:
  if ThirdMostRecentHpvReport.date occurs after DateOfLastCervicalPrecancerTreatment then
    ThirdMostRecentHpvResult
  else
    null

define MostRecentCytologyResultAfterTreatment:
  if MostRecentHpvResultAfterTreatment is null then
    null
  else
    MostRecentCytologyCotestResult

define SecondMostRecentCytologyResultAfterTreatment:
  if SecondMostRecentHpvResultAfterTreatment is null then
    null
  else
    SecondMostRecentCytologyCotestResult

define ThirdMostRecentCytologyResultAfterTreatment:
  if ThirdMostRecentHpvResultAfterTreatment is null then
    null
  else
    ThirdMostRecentCytologyCotestResult

//------------------------------------------------------------------------------
// RECOMMENDATIONS FOR RARE ABNORMALITIES
//------------------------------------------------------------------------------

/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
// RARE ABNORMALITY #1: Rare Cytology

define MostRecentCytologyReport:
  if Count(SortedCytologyReports) > 0 then
    SortedCytologyReports[0]
  else
    null

define MostRecentCytologyReportWasWithinPastFiveYears:
  MostRecentCytologyReport.date >= Now() - 5 years

define CytologyInterpretedAsAgc:
  AnyTrue(
    (MostRecentCytologyReport.allConclusions) aC
      return aC ~ "AGC"
  )

define CytologyInterpretedAsAgcFavorNeoplasia:
  AnyTrue(
    (MostRecentCytologyReport.allConclusions) aC
      return aC ~ "AGC Favor Neoplasia"
  )

define CytologyInterpretedAsAis:
  AnyTrue(
    (MostRecentCytologyReport.allConclusions) aC
      return aC in Dash."AIS"
  )

define CytologyInterpretedAsAgcOrAis:
  CytologyInterpretedAsAgc or
  CytologyInterpretedAsAis

define CytologyInterpretedAsAtypicalEndometrialCells:
  AnyTrue(
    (MostRecentCytologyReport.allConclusions) aC
      return aC ~ "Atypical Endometrial Cells"
  )

define CytologyInterpretedAsAtypicalEndocervicalCells:
  AnyTrue(
    (MostRecentCytologyReport.allConclusions) aC
      return aC ~ "Atypical Endocervical Cells"
  )

define CytologyInterpretedAsEndocervicalAis:
  AnyTrue(
    (MostRecentCytologyReport.allConclusions) aC
      return aC ~ "Endocervical AIS"
  )

define CytologyInterpretedAsEndocervicalCellsFavorNeoplasia:
  AnyTrue(
    (MostRecentCytologyReport.allConclusions) aC
      return aC ~ "Endocervical Cells Favor Neoplasia"
  )

define CytologyUnsatisfactory:
  AnyTrue(
    (MostRecentCytologyReport.allConclusions) aC
      return aC ~ "Unsatisfactory"
  )

define CytologyAbsentTransformationZone:
  AnyTrue(
    (MostRecentCytologyReport.allConclusions) aC
      return aC ~ "Absent Transformation Zone"
  )

define CytologyInterpretedAsNilm:
  AnyTrue(
    (MostRecentCytologyReport.allConclusions) aC
      return aC ~ Dash."NILM"
  )

define SecondMostRecentCytologyInterpretedAsNilm:
  AnyTrue(
    (SecondMostRecentCytologyReport.allConclusions) aC
      return aC ~ Dash."NILM"
  )

define CytologyInterpretedAsBenignEndometrialCells:
  AnyTrue(
    (MostRecentCytologyReport.allConclusions) aC
      return aC ~ "Benign Endometrial Cells"
  )

define CytologyInterpretedAsBenignGlandularCells:
  AnyTrue(
    (MostRecentCytologyReport.allConclusions) aC
      return aC ~ "Benign Glandular Cells"
  )

define CytologyInterpretedAsEndometrialStromalCells:
  AnyTrue(
    (MostRecentCytologyReport.allConclusions) aC
      return aC ~ "Endometrial Stromal Cells"
  )

define CytologyInterpretedAsHistiocytes:
  AnyTrue(
    (MostRecentCytologyReport.allConclusions) aC
      return aC ~ "Histiocytes"
  )

define PremenopausalObservations:
  C3F.Verified(
    [Observation: "Premenopausal"] union
    [Observation: "Premenopausal Menorrhagia"] union
    [Observation: "Excessive Bleeding in the Premenopausal Period"]
  )

define HasPremenopausalObservation:
  Exists(PremenopausalObservations)

define PostmenopausalObservations:
  C3F.Verified(
    [Observation: "Postmenopausal"]
  )

define HasPostmenopausalObservation:
  Exists(PostmenopausalObservations)

define Pregnant:
  Exists(Dash.PregnancyDiagnoses) or
  Exists(Dash.PregnancyObservations)

define HistologyInterpretedAsCin1:
  AnyTrue(
    (MostRecentBiopsyReport.allConclusions) aC
      return
        aC ~ "CIN1"
  )

define HistologyInterpretedAsNormal:
  AnyTrue(
    (MostRecentBiopsyReport.allConclusions) aC
      return
        aC ~ "Biopsy Normal"
  )

define HistologyInterpretedAsCin1OrNormal:
  HistologyInterpretedAsCin1 or
  HistologyInterpretedAsNormal

define HistologyInterpretedAsCancer:
  AnyTrue(
    (MostRecentBiopsyReport.allConclusions) aC
      return
        aC in Dash."Histologic cancer"
  )

define CancerDiagnosisAfterMostRecentCytology:
  Exists(
    Dash.CervicalCancerDiagnoses C
      where Common.ConditionDate(C) > MostRecentCytologyReport.date
  )

define AnyHpvSinceMostRecentCytology:
  Exists(
    (SortedHpvReports) B
      where B.date >= MostRecentCytologyReport.date - 1 day
  )

define UnknownHpvCotest:
  MostRecentHpvReport.date within 1 day of MostRecentCytologyReport.date and
  AnyTrue(
    (MostRecentHpvReport.allConclusions) aC
      return
        aC ~ "Unknown" or
        not (aC in "All Results of High Risk HPV Test")
  )

define NegativeOrUnknownHpvCotest:
  MostRecentHpvReport.date within 1 day of MostRecentCytologyReport.date and
  AnyTrue(
    (MostRecentHpvReport.allConclusions) aC
      return
        aC ~ Dash."Negative HPV Finding" or aC ~ Dash."Negative" or
        aC ~ "Unknown" or
        not (aC in "All Results of High Risk HPV Test")
  )

define PositiveHpvCotest:
  MostRecentHpvReport.date within 1 day of MostRecentCytologyReport.date and
  AnyTrue(
    (MostRecentHpvReport.allConclusions) aC
      return
        aC ~ Dash."Positive HPV Finding"
  )

define PositiveHpv16or18Cotest:
  MostRecentHpvReport.date within 1 day of MostRecentCytologyReport.date and
  AnyTrue(
    (MostRecentHpvReport.allConclusions) aC
      return
        aC ~ "HPV16+ Antigen" or
        aC ~ "HPV16+ DNA" or
        aC ~ "HPV18+ Antigen" or
        aC ~ "HPV18+ DNA"
  )

define HasRemovalOfCervixProcedures:
  Exists(Dash.RemovalOfCervixProcedures)

define HasAbsenceOfCervixDiagnoses:
  Exists(Dash.AbsenceOfCervixDiagnoses)

define HasAbsenceOfCervixObservations:
  Exists(Dash.AbsenceOfCervixObservations)

define AbsenceOrRemovalOfCervix:
  HasRemovalOfCervixProcedures or
  HasAbsenceOfCervixDiagnoses or
  HasAbsenceOfCervixObservations

define RecommendationForRareCytology:
  case
    // G.1 Evaluation of Cytology Interpreted as AGC or AIS
    when (
      AgeInYears() < 35 and
      MostRecentCytologyReportWasWithinPastFiveYears and
      CytologyInterpretedAsAgcOrAis and
      not CytologyInterpretedAsAtypicalEndometrialCells and
      not Pregnant
    ) then
      {
        action: null,
        text: 'For nonpregnant patients of all ages with all subcategories of AGC and AIS, except when atypical endometrial cells are specified, colposcopy is recommended regardless of HPV test result; endocervical sampling is recommended at initial colposcopy except in pregnancy (for management in pregnancy, see Section K.2) (AII). Accordingly, triage by reflex HPV testing is not recommended, and triage by repeat cytology is unacceptable (DII). Endometrial sampling is also recommended for nonpregnant patients younger than 35 years at increased risk of endometrial neoplasia based on clinical indications (e.g., abnormal uterine bleeding, conditions suggesting chronic anovulation, or obesity) (AII).'
      }
    when (
      AgeInYears() >= 35 and
      MostRecentCytologyReportWasWithinPastFiveYears and
      CytologyInterpretedAsAgcOrAis and
      not CytologyInterpretedAsAtypicalEndometrialCells and
      not Pregnant
    ) then
      {
        action: null,
        text: 'For nonpregnant patients of all ages with all subcategories of AGC and AIS, except when atypical endometrial cells are specified, colposcopy is recommended regardless of HPV test result; endocervical sampling is recommended at initial colposcopy except in pregnancy (for management in pregnancy, see Section K.2) (AII). Accordingly, triage by reflex HPV testing is not recommended, and triage by repeat cytology is unacceptable (DII). Endometrial sampling is recommended in conjunction with colposcopy and endocervical sampling in nonpregnant patients 35 years or older with all categories of AGC and AIS (AII).'
      }
    when (
      MostRecentCytologyReportWasWithinPastFiveYears and
      CytologyInterpretedAsAgcOrAis and
      CytologyInterpretedAsAtypicalEndometrialCells and
      not Pregnant
    ) then
      {
        action: null,
        text: 'For patients with atypical endometrial cells specified, initial evaluation limited to endometrial and endocervical sampling is preferred, with colposcopy acceptable at the time of initial evaluation. If colposcopy was deferred and no endometrial pathology is identified, additional evaluation with colposcopy is then recommended.'
      }
    // Subsequent Management
    when (
      MostRecentCytologyReportWasWithinPastFiveYears and
      (
        CytologyInterpretedAsAgc or
        CytologyInterpretedAsAtypicalEndocervicalCells
      ) and
      MostRecentBiopsyReport.date 12 months or less after MostRecentCytologyReport.date and
      HistologyInterpretedAsCin1OrNormal
    ) then
      {
        action: null,
        text: 'For patients with cytology showing AGC not otherwise specified or atypical endocervical cells not otherwise specified in whom histologic HSIL (CIN 2+) or AIS/cancer is not identified, cotesting at one and two years is recommended. If both cotests are negative, repeat cotesting at 3 years is recommended. If any test is abnormal, then colposcopy is recommended (BII).'
      }
    when (
      MostRecentCytologyReportWasWithinPastFiveYears and
      (
        CytologyInterpretedAsAgcFavorNeoplasia or
        CytologyInterpretedAsEndocervicalCellsFavorNeoplasia or
        CytologyInterpretedAsEndocervicalAis
      ) and
      not (
        CancerDiagnosisAfterMostRecentCytology or
        (
          HistologyInterpretedAsCancer and
          MostRecentBiopsyReport.date > MostRecentCytologyReport.date
        )
      )
    ) then
      {
        action: null,
        text: 'For patients with atypical glandular or endocervical cells “favor neoplasia” or endocervical AIS cytology, if invasive disease is not identified during initial colposcopic workup, a diagnostic excisional procedure is recommended. The diagnostic excisional procedure used in this setting should provide an intact specimen with interpretable margins (BII). Endocervical sampling above the excisional bed is preferred (BII).'
      }
    // G.2 Unsatisfactory Cytology
    when (
      MostRecentCytologyReportWasWithinPastFiveYears and
      CytologyUnsatisfactory and
      (
        not AnyHpvSinceMostRecentCytology or
        NegativeOrUnknownHpvCotest
      )
    ) then
      {
        action: null,
        text: 'For patients with an unsatisfactory cytology result and no, unknown, or a negative HPV test result, repeat age-based screening (cytology, cotest, or primary HPV test) in 2 to 4 months is recommended (BIII). Triage using HPV testing is not recommended (DIII). Before repeat cytology, treatment to resolve atrophy or obscuring inflammation when a specific infection is present is acceptable (CIII).'
      }
    when (
      MostRecentCytologyReportWasWithinPastFiveYears and
      CytologyUnsatisfactory and
      PositiveHpvCotest and
      AgeInYears() >= 25
    ) then
      {
        action: null,
        text: 'For patients 25 years and older who are cotested and have unsatisfactory cytology and a positive HPV test without genotyping, repeat cytology in 2 to 4 months or colposcopy is acceptable (BII).'
      }
    when (
      MostRecentCytologyReportWasWithinPastFiveYears and
      CytologyUnsatisfactory and
      PositiveHpv16or18Cotest and
      AgeInYears() >= 25
    ) then
      {
        action: null,
        text: 'For patients 25 years and older who are cotested and have unsatisfactory cytology and a positive HPV test with partial genotyping is positive for HPV 16 or HPV 18, direct referral for colposcopy is recommended (BII).'
      }
    // G.3 Absent Transformation Zone on Screening Cytology
    when (
      AgeInYears() in Interval[21,30) and
      MostRecentCytologyReportWasWithinPastFiveYears and
      CytologyAbsentTransformationZone and
      CytologyInterpretedAsNilm
    ) then
      {
        action: null,
        text: 'Routine screening is recommended (BIII). When cervical cytology alone is performed for screening, HPV testing as a triage test after negative cytology and absent endocervical cells/transformation zone component in this age group is unacceptable (DIII).'
      }
    when (
      AgeInYears() >= 30 and
      MostRecentCytologyReportWasWithinPastFiveYears and
      CytologyAbsentTransformationZone and
      CytologyInterpretedAsNilm and
      (
        not AnyHpvSinceMostRecentCytology or
        UnknownHpvCotest
      )
    ) then
      {
        action: null,
        text: 'HPV testing is preferred (BIII). Repeat cytology in 3 years is acceptable if HPV testing is not performed (BIII). If HPV testing is performed, manage using Clinical Action Thresholds according to 2019 consensus guidelines.'
      }
    // G.4 Benign Endometrial Cells in Premenopausal Patients or Benign Glandular Cells in Posthysterectomy patients
    when (
      HasPremenopausalObservation and
      not Symptomatic.IsSymptomatic and
      MostRecentCytologyReportWasWithinPastFiveYears and
      (
        CytologyInterpretedAsBenignEndometrialCells or
        CytologyInterpretedAsEndometrialStromalCells or
        CytologyInterpretedAsHistiocytes
      )
    ) then
      {
        action: null,
        text: 'For asymptomatic premenopausal patients with benign endometrial cells, endometrial stromal cells, or histiocytes, no further evaluation is recommended (BII).'
      }
    when (
      HasPostmenopausalObservation and
      MostRecentCytologyReportWasWithinPastFiveYears and
      CytologyInterpretedAsBenignEndometrialCells
    ) then
      {
        action: null,
        text: 'For postmenopausal patient with benign endometrial cells found via cytology, endometrial assessment is recommended (BII).'
      }
    when (
      AbsenceOrRemovalOfCervix and
      MostRecentCytologyReportWasWithinPastFiveYears and
      CytologyInterpretedAsBenignGlandularCells
    ) then
      {
        action: null,
        text: 'For patients “post-hysterectomy” with benign endometrial cells identified via cytology, no further evaluation is recommended (BII).'
      }
    else
      null
  end

/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
// RARE ABNORMALITY #2: Exceptions to Colposcopy Clinical Action Threshold

define CytologyInterpretedAsAscH:
  AnyTrue(
    (MostRecentCytologyReport.allConclusions) aC
      return aC ~ "ASC-H"
  )

define SecondMostRecentCytologyReport:
  if Count(SortedCytologyReports) > 1 then
    SortedCytologyReports[1]
  else
    null

define TwoMostRecentCytologyReportsWithin5yearsApart:
  SecondMostRecentCytologyReport.date within 5 years of MostRecentCytologyReport.date

define SecondMostRecentCytologyUnsatisfactory:
  AnyTrue(
    (SecondMostRecentCytologyReport.allConclusions) aC
      return aC ~ "Unsatisfactory"
  )

define RecommendationForExceptionsToColposcopyThreshold:
  case
    when (
      MostRecentCytologyReportWasWithinPastFiveYears and
      CytologyInterpretedAsAscH
    ) then
      {
        action: null,
        text: 'For patients with ASC-H cytology, colposcopy is recommended regardless of hrHPV result (AII).'
      }
    when (
      MostRecentCytologyReportWasWithinPastFiveYears and
      PositiveHpv16or18Cotest and
      CytologyInterpretedAsNilm
    ) then
      {
        action: null,
        text: 'For patients with hrHPV 18–positive NILM or hrHPV 16-positive NILM, colposcopy is recommended (AII).'
      }
    when (
      MostRecentCytologyReportWasWithinPastFiveYears and
      CytologyUnsatisfactory and
      TwoMostRecentCytologyReportsWithin5yearsApart and
      SecondMostRecentCytologyUnsatisfactory
    ) then
      {
        action: null,
        text: 'Colposcopy should be performed after 2 consecutive unsatisfactory screening tests (CIII).'
      }
    else
      null
  end

/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
// RARE ABNORMALITY #3: Managing Histology Results

define MostRecentBiopsyReportWasWithinPastYear:
  MostRecentBiopsyReport.date >= Now() - 1 year

define HistologyInterpretedAsCin2:
  AnyTrue(
    (MostRecentBiopsyReport.allConclusions) aC
      return
        aC ~ Dash."CIN2"
  )

define HistologyInterpretedAsCin3:
  AnyTrue(
    (MostRecentBiopsyReport.allConclusions) aC
      return
        aC ~ Dash."CIN3"
  )

define HistologyInterpretedAsAis:
  AnyTrue(
    (MostRecentBiopsyReport.allConclusions) aC
      return
        aC in Dash."AIS"
  )

define HistologyInterpretedAsUnspecifiedHsil:
  AnyTrue(
    (MostRecentBiopsyReport.allConclusions) aC
      return
        aC ~ Dash."HSIL, Unspecified"
  )

define PrecedingCytologyResults:
  Coalesce(
    (SortedCytologyReports) S
      where S.date <= MostRecentBiopsyReport.date and
        S.date >= MostRecentBiopsyReport.date - 6 months
  )

define PrecedingCytologyIsHsil:
  AnyTrue(
    (PrecedingCytologyResults.allConclusions) aC
      return
        aC in "HSIL"
  )

define PrecedingCytologyIsAscH:
  AnyTrue(
    (PrecedingCytologyResults.allConclusions) aC
      return
        aC ~ "ASC-H"
  )

define PrecedingCytologyResultsBeforeSecondMostRecentBiopsy:
  Coalesce(
    (SortedCytologyReports) S
      where S.date <= SecondMostRecentBiopsyReport.date and
        S.date >= SecondMostRecentBiopsyReport.date - 6 months
  )

define PrecedingCytologyBeforeSecondMostRecentBiopsyIsHsil:
  AnyTrue(
    (PrecedingCytologyResultsBeforeSecondMostRecentBiopsy.allConclusions) aC
      return
        aC in "HSIL"
  )

define PrecedingCytologyBeforeSecondMostRecentBiopsyIsAscH:
  AnyTrue(
    (PrecedingCytologyResultsBeforeSecondMostRecentBiopsy.allConclusions) aC
      return
        aC ~ "ASC-H"
  )

define SecondMostRecentBiopsyReport:
  if Count(SortedBiopsyReports) > 1 then
      SortedBiopsyReports[1]
  else
    null

define SecondMostRecentHistologyInterpretedAsCin1:
  AnyTrue(
    (SecondMostRecentBiopsyReport.allConclusions) aC
      return
        aC ~ "CIN1"
  )

define SecondMostRecentHistologyInterpretedAsNormal:
  AnyTrue(
    (SecondMostRecentBiopsyReport.allConclusions) aC
      return
        aC ~ "Biopsy Normal"
  )

define SecondMostRecentHistologyInterpretedAsCin1OrNormal:
  SecondMostRecentHistologyInterpretedAsCin1 or
  SecondMostRecentHistologyInterpretedAsNormal

define MostRecentBiopsyReportWasWithinPast12months:
  MostRecentBiopsyReport.date >= Now() - 12 months

define MostRecentBiopsyReportWasWithinPast18months:
  MostRecentBiopsyReport.date >= Now() - 18 months

define TwoMostRecentBiopsyReportsWithin18monthsApart:
  SecondMostRecentBiopsyReport.date within 18 months of MostRecentBiopsyReport.date

define TwoMostRecentBiopsyReportsWithin15monthsApart:
  SecondMostRecentBiopsyReport.date within 15 months of MostRecentBiopsyReport.date

define RecentlyRespondedYesToFuturePregnancyConcernsQuestion:
  C3F.MostRecent(
    C3F.ObservationLookBack(
      Dash.ResponsesToFuturePregnancyConcernsQuestion R
        where R.value ~ Dash."Yes",
      3 months
    )
  ) is not null

define InitialCervicalHistologyInterpretedAsUnspecifiedHsilOrCin2InLast18Months:
  First(
    (SortedBiopsyReports) B
      where B.date >= Now() - 18 months and
      AnyTrue(
        (B.allConclusions) aC
          return
            aC ~ Dash."HSIL, Unspecified" or
            aC ~ Dash."CIN2"
      )
  )

define InitialCervicalHistologyInterpretedAsUnspecifiedHsilOrCin2InLast6Years:
  First(
    (SortedBiopsyReports) B
      where B.date >= Now() - 6 years and
      AnyTrue(
        (B.allConclusions) aC
          return
            aC ~ Dash."HSIL, Unspecified" or
            aC ~ Dash."CIN2"
      )
  )

define HistologyInterpretedAsUnspecifiedHsilOrCin2BeforeMostRecentBiopsy:
  (SortedBiopsyReports) B
    where
      B.date 2 years or more before MostRecentBiopsyReport.date and
      B.date 2.5 years or less before MostRecentBiopsyReport.date and
      AnyTrue(
        (B.allConclusions) aC
          return
            aC ~ Dash."HSIL, Unspecified" or
            aC ~ Dash."CIN2"
      )

define HasHistologyInterpretedAsUnspecifiedHsilOrCin2BeforeMostRecentBiopsy:
  Exists(HistologyInterpretedAsUnspecifiedHsilOrCin2BeforeMostRecentBiopsy)

define MostRecentNegativeHsilSurveillanceResult:
  if (InitialCervicalHistologyInterpretedAsUnspecifiedHsilOrCin2InLast18Months is not null) then
    MostRecentBiopsyReport.date 18 months or less after InitialCervicalHistologyInterpretedAsUnspecifiedHsilOrCin2InLast18Months.date and
    HistologyInterpretedAsCin1OrNormal and
    MostRecentCytologyReport.date 18 months or less after InitialCervicalHistologyInterpretedAsUnspecifiedHsilOrCin2InLast18Months.date and
    (
      CytologyInterpretedAsLsil or
      CytologyInterpretedAsAscus or
      CytologyInterpretedAsNilm
    )
  else
    false

define SecondMostRecentNegativeHsilSurveillanceResult:
  if (InitialCervicalHistologyInterpretedAsUnspecifiedHsilOrCin2InLast18Months is not null) then
    SecondMostRecentBiopsyReport.date 18 months or less after InitialCervicalHistologyInterpretedAsUnspecifiedHsilOrCin2InLast18Months.date and
    SecondMostRecentHistologyInterpretedAsCin1OrNormal and
    SecondMostRecentCytologyReport.date 18 months or less after InitialCervicalHistologyInterpretedAsUnspecifiedHsilOrCin2InLast18Months.date and
    (
      SecondMostRecentCytologyInterpretedAsLsil or
      SecondMostRecentCytologyInterpretedAsAscus or
      SecondMostRecentCytologyInterpretedAsNilm
    )
  else
    false

define SubsequentLowGradeHistologyReportsSinceInitialUnspecifiedHsilOrCin2InLast6Years:
  if (InitialCervicalHistologyInterpretedAsUnspecifiedHsilOrCin2InLast6Years is not null) then
    SortedBiopsyReports R
      where R.date after InitialCervicalHistologyInterpretedAsUnspecifiedHsilOrCin2InLast6Years.date and
      AnyTrue(
        (R.allConclusions) aC
          return
            aC ~ "CIN1" or
            aC ~ "Biopsy Normal"
      )
  else
    null

define SubsequentLowGradeCytologyReportsSinceInitialUnspecifiedHsilOrCin2InLast6Years:
  if (InitialCervicalHistologyInterpretedAsUnspecifiedHsilOrCin2InLast6Years is not null) then
    SortedCytologyReports R
      where R.date after InitialCervicalHistologyInterpretedAsUnspecifiedHsilOrCin2InLast6Years.date and
      AnyTrue(
        (R.allConclusions) aC
          return
            aC ~ Dash."NILM" or
            aC ~ "LSIL" or
            aC ~ "ASC-US"
      )
  else
    null

define MostRecentSurveillanceTestNegative:
  (
    MostRecentHpvResult = 'HPV-negative' and
    MostRecentCytologyCotestResult = 'NILM'
  ) or
  (
    MostRecentHpvResult = 'HPV-negative' and
    MostRecentCytologyCotest is null
  )

define RecommendationForHistologyResults:
  case
    // I.1 Management of Histologic HSIL, not Further Specified or Qualified
    when (
      AgeInYears() >= 25 and
      MostRecentBiopsyReportWasWithinPastYear and
      HistologyInterpretedAsUnspecifiedHsil
    ) then
      {
        action: null,
        text: 'Treatment is preferred if histologic HSIL cannot be specified (e.g., reported as histologic HSIL or histologic HSIL [CIN 2,3]) (CIII), but observation is acceptable if there are concerns related to future pregnancies (CIII). For patients 25 years or older, observation includes colposcopy and HPV-based testing with cotest or primary hrHPV testing at 6-month intervals for up to 2 years.'
      }
    // I.2 Management of Histologic HSIL (CIN2 or CIN3)
    when ( // 1
      AgeInYears() >= 25 and
      not Pregnant and
      MostRecentBiopsyReportWasWithinPastYear and
      HistologyInterpretedAsCin3
    ) then
      {
        action: null,
        text: 'Treatment is recommended, and observation is unacceptable (AII). When treatment of histologic HSIL is planned, excisional treatment is preferred, and treatment with ablation is acceptable (BI). Outside of the setting of a clinical research trial, nonsurgical therapies, including topical agents, therapeutic vaccines, and other biologics, are unacceptable for the treatment of histologic HSIL (CIN 2 or CIN 3) (DIII). Hysterectomy is unacceptable as primary therapy solely for the treatment of histologic HSIL (CIN 2, CIN 3, or unqualified) (EII). When considering ablative therapy, in particular cryotherapy, ablation is unacceptable in the following circumstances as defined by the WHO: (a) the lesion extends into the canal and (b) when the lesion covers more than 75% of the surface area of the ectocervix or extends beyond the cryotip being used.97 Additional situations for which cryotherapy is not recommended include the following: (a) the squamocolumnar junction or the upper limit of any lesion is not fully visualized; (b) endocervical canal sample is diagnosed as CIN 2+ or CIN that cannot be graded; (c) after previous treatment for CIN 2+; (d) in the setting of inadequate biopsies of the cervix to confirm histologic diagnosis; and (e) if cancer is suspected (EIII).'
      }
    when ( // 2
      AgeInYears() >= 25 and
      not Pregnant and
      MostRecentBiopsyReportWasWithinPastYear and
      HistologyInterpretedAsCin2
    ) then
      {
        action: null,
        text: 'Treatment is recommended unless the patient\'s concerns about the effect of treatment on future pregnancy outweigh concerns about cancer (BII). Observation is unacceptable when the squamocolumnar junction or the upper limit of the lesion is not fully visualized or when the results of an endocervical sampling, if performed, is CIN 2+ or ungraded (EIII). For patients with a diagnosis of histologic HSIL (CIN 2) whose concerns about the effects of treatment on a future pregnancy outweigh their concerns about cancer, either observation or treatment is acceptable provided the squamocolumnar junction is visible and CIN 2+ or ungraded CIN is not identified on endocervical sampling (CII). For patients 25 years or older, observation includes colposcopy and HPV-based testing with cotest or primary hrHPV testing at 6-month intervals for up to 2 years.\n\nWhen treatment of histologic HSIL is planned, excisional treatment is preferred, and treatment with ablation is acceptable (BI). Outside of the setting of a clinical research trial, nonsurgical therapies, including topical agents, therapeutic vaccines, and other biologics, are unacceptable for the treatment of histologic HSIL (CIN 2 or CIN 3) (DIII). Hysterectomy is unacceptable as primary therapy solely for the treatment of histologic HSIL (CIN 2, CIN 3, or unqualified) (EII). When considering ablative therapy, in particular cryotherapy, ablation is unacceptable in the following circumstances as defined by the WHO: (a) the lesion extends into the canal and (b) when the lesion covers more than 75% of the surface area of the ectocervix or extends beyond the cryotip being used.97 Additional situations for which cryotherapy is not recommended include the following: (a) the squamocolumnar junction or the upper limit of any lesion is not fully visualized; (b) endocervical canal sample is diagnosed as CIN 2+ or CIN that cannot be graded; (c) after previous treatment for CIN 2+; (d) in the setting of inadequate biopsies of the cervix to confirm histologic diagnosis; and (e) if cancer is suspected (EIII).'
      }
    // I.3 Management of CIN2 in Those Who Are Concerned About the Potential Effect of Treatment on Future Pregnancy Outcomes
    when ( // 1
      AgeInYears() >= 25 and AgeInYears() <= 50 and
      MostRecentBiopsyReportWasWithinPastYear and
      HistologyInterpretedAsCin2 and
      RecentlyRespondedYesToFuturePregnancyConcernsQuestion
    ) then
      {
        action: null,
        text: 'For patients with a diagnosis of histologic HSIL (CIN 2) whose concerns about the effects of treatment on a future pregnancy outweigh their concerns about cancer, either observation or treatment is acceptable provided the squamocolumnar junction is visible and CIN 2+ or ungraded CIN is not identified on endocervical sampling (CII). For patients 25 years or older, observation includes colposcopy and HPV-based testing with cotest or primary hrHPV testing at 6-month intervals for up to 2 years.'
      }
    when ( // 2
      AgeInYears() >= 25 and AgeInYears() <= 50 and
      MostRecentBiopsyReportWasWithinPastYear and
      HistologyInterpretedAsUnspecifiedHsil
      RecentlyRespondedYesToFuturePregnancyConcernsQuestion
    ) then
      {
        action: null,
        text: 'If the histologic HSIL cannot be specified as CIN 2, treatment is preferred, but observation is acceptable if there are concerns related to future pregnancies (CIII). For patients 25 years or older, observation includes colposcopy and HPV-based testing with cotest or primary hrHPV testing at 6-month intervals for up to 2 years.'
      }
    when ( // 3
      AgeInYears() >= 25 and AgeInYears() <= 50 and
      (InitialCervicalHistologyInterpretedAsUnspecifiedHsilOrCin2InLast18Months is not null) and
      MostRecentNegativeHsilSurveillanceResult
      SecondMostRecentNegativeHsilSurveillanceResult and
      RecentlyRespondedYesToFuturePregnancyConcernsQuestion
    ) then
      {
        action: null,
        text: 'Subsequent surveillance with colposcopy and HPV-based testing should occur every year since the patient has demonstrated less than CIN2 and less than ASC-H during surveillance following a histologic unspecified or CIN2 result.'
      }
    when ( // 4
      AgeInYears() >= 25 and AgeInYears() <= 50 and
      (InitialCervicalHistologyInterpretedAsUnspecifiedHsilOrCin2InLast6Years is not null) and
      Count(SubsequentLowGradeHistologyReportsSinceInitialUnspecifiedHsilOrCin2InLast6Years) >= 5 and
      Count(SubsequentLowGradeCytologyReportsSinceInitialUnspecifiedHsilOrCin2InLast6Years) >= 5 and
      RecentlyRespondedYesToFuturePregnancyConcernsQuestion
    ) then
      {
        action: null,
        text: 'Surveillance testing with colposcopy and HPV-based testing is recommended every 3 years for 25 years after histologic HSIL (unspecified or CIN2) even if beyond the age of 65 (BII).'
      }
    when ( // 5
      AgeInYears() >= 25 and AgeInYears() <= 50 and
      (
        HistologyInterpretedAsUnspecifiedHsil or
        HistologyInterpretedAsCin2
      ) and
      HasHistologyInterpretedAsUnspecifiedHsilOrCin2BeforeMostRecentBiopsy
    ) then
      {
        action: null,
        text: 'If CIN 2 remains present for a 2-year period, treatment is recommended (CII).'
      }
    // I.4 Management of LSIL (CIN1) or Less Preceded by ASC-H or HSIL Cytology
    when ( // 1
      AgeInYears() >= 25 and
      MostRecentBiopsyReportWasWithinPastYear and
      HistologyInterpretedAsCin1OrNormal and
      PrecedingCytologyIsHsil
    ) then
      {
        action: null,
        text: 'When CIN 2+ is not identified, HSIL cytology is managed more aggressively than ASC-H cytology. For cytology showing HSIL, but biopsy showing histologic LSIL (CIN 1) or less, either an immediate diagnostic excisional procedure or observation with HPV-based testing and colposcopy at 1 year is acceptable, provided in the latter case that the initial colposcopic examination fully visualized the squamocolumnar junction and the upper limit of any lesion, and that the endocervical sampling, if collected, was less than CIN 2 (BII). When CIN2+ is not identified histologically after an ASC-H or HSIL cytology result, it is acceptable to review the cytologic, histologic, and colposcopic findings. If the review yields a revised interpretation, management should follow guidelines for the revised diagnosis (CIII).'
      }
    when ( // 2
      AgeInYears() >= 25 and
      MostRecentBiopsyReportWasWithinPastYear and
      HistologyInterpretedAsCin1OrNormal and
      PrecedingCytologyIsAscH
    ) then
      {
        action: null,
        text: 'For ASC-H, if the colposcopic examination can fully visualize the squamocolumnar junction and the upper limit of any lesion and that the endocervical sampling, if collected, is negative, observation at 1 year with HPV-based testing with cotesting or primary hrHPV testing is recommended; a diagnostic excisional procedure is not recommended (BII).'
      }
    when ( // 3 - Recommendation #1
      AgeInYears() >= 25 and
      (
        (
          (
            MostRecentBiopsyReportWasWithinPast18months and
            HistologyInterpretedAsNormal and
            TwoMostRecentBiopsyReportsWithin18monthsApart
          ) and
          (
            HasFirstNegativeSurveillanceTestAfterSecondMostRecentBiopsy and
            FirstNegativeSurveillanceTestAfterSecondMostRecentBiopsy.date > Now() - 18 months and
            FirstNegativeSurveillanceTestAfterSecondMostRecentBiopsy.date 18 months or less after SecondMostRecentBiopsyReport.date
          ) and
          (
            SecondMostRecentHistologyInterpretedAsCin1OrNormal and
            PrecedingCytologyBeforeSecondMostRecentBiopsyIsHsil
          ) and
          not (
          MostRecentTreatmentDate 1 year or less after SecondMostRecentBiopsyReport.date
          )
        ) or
        (
          (
            HasFirstNegativeSurveillanceTestAfterMostRecentBiopsy and
            FirstNegativeSurveillanceTestAfterMostRecentBiopsy.date > Now() - 18 months and
            FirstNegativeSurveillanceTestAfterMostRecentBiopsy.date 18 months or less after MostRecentBiopsyReport.date
          ) and
          (
            HistologyInterpretedAsCin1OrNormal and
            PrecedingCytologyIsAscH
          ) and
          not (
            MostRecentTreatmentDate 1 year or less after MostRecentBiopsyReport.date
          )
        )
      )
    ) then
      {
        action: null,
        text: 'HPV-based testing (i.e., cotesting or primary hrHPV testing) is recommended 1 year after the initial negative follow up result(s) when observation is elected after a histologic LSIL (CIN1) preceded by ASC-H or HSIL cytology.'
      }
    when ( // 3 - Recommendation #2
      AgeInYears() >= 25 and
      MostRecentSurveillanceTestNegative and
      MostRecentHpvReport.date >= Now() - 3.5 years and
      (
        (
          (
            MostRecentBiopsyReport.date 18 months or less before MostRecentHpvReport.date and
            HistologyInterpretedAsNormal and
            TwoMostRecentBiopsyReportsWithin18monthsApart
          ) and
          (
            HasFirstNegativeSurveillanceTestAfterSecondMostRecentBiopsy and
            FirstNegativeSurveillanceTestAfterSecondMostRecentBiopsy.date 18 months or less before MostRecentHpvReport.date and
            FirstNegativeSurveillanceTestAfterSecondMostRecentBiopsy.date 18 months or less after SecondMostRecentBiopsyReport.date
          ) and
          (
            SecondMostRecentHistologyInterpretedAsCin1OrNormal and
            PrecedingCytologyBeforeSecondMostRecentBiopsyIsHsil
          ) and
          not (
          MostRecentTreatmentDate 1 year or less after SecondMostRecentBiopsyReport.date
          )
        ) or
        (
          (
            HasFirstNegativeSurveillanceTestAfterMostRecentBiopsy and
            FirstNegativeSurveillanceTestAfterMostRecentBiopsy.date 18 months or less before MostRecentHpvReport.date and
            FirstNegativeSurveillanceTestAfterMostRecentBiopsy.date 18 months or less after MostRecentBiopsyReport.date
          ) and
          (
            HistologyInterpretedAsCin1OrNormal and
            PrecedingCytologyIsAscH
          ) and
          not (
            MostRecentTreatmentDate 1 year or less after MostRecentBiopsyReport.date
          )
        )
      )
    ) then
      {
        action: null,
        text: 'Retest with HPV-based testing (i.e., cotesting or primary hrHPV testing) every 3 years after surveillance tests are negative during the 2-year observation period following histologic LSIL (CIN1) or less preceded by ASC-H or HSIL cytology. Proceed with long-term surveillance (i.e., HPV-based testing every 3 years for at least 25 years, even if this is beyond the age of 65 years (BII).'
      }
    when ( // 4
      AgeInYears() >= 25 and
      HistologyInterpretedAsCin1OrNormal and
      (
        PrecedingCytologyIsHsil or
        PrecedingCytologyIsAscH
      ) and
      not (
        MostRecentTreatmentDate 1 year or less after MostRecentBiopsyReport.date
      ) and
      (
        (
          (MostRecentCytologyReport is not null) and
          not CytologyInterpretedAsNilm and
          not CytologyInterpretedAsHsil and
          MostRecentCytologyReport.date 1 year or more after MostRecentBiopsyReport.date and
          MostRecentCytologyReport.date less than 3 years after MostRecentBiopsyReport.date
        ) or
        (
          (MostRecentHpvReport is not null) and
          MostRecentHpvResult != 'HPV-negative' and
          MostRecentHpvReport.date 1 year or more after MostRecentBiopsyReport.date and
          MostRecentHpvReport.date less than 3 years after MostRecentBiopsyReport.date
        ) or
        (
          // TODO: As written, this part of the path will not trigger. Going forward, we should look into a way to clarify the lookback for 'LSIL (CIN1) or Less Preceded by ASC-H or HSIL Cytology' so that it is not reliant on the MostRecentBiopsyReport
          (MostRecentBiopsyReport is not null) and
          not HistologyInterpretedAsNormal and
          MostRecentBiopsyReport.date 1 year or more after MostRecentBiopsyReport.date and
          MostRecentBiopsyReport.date less than 3 years after MostRecentBiopsyReport.date
        )
      )
    ) then
      {
        action: null,
        text: 'If any test is abnormal during the observation period after a HSIL and ASC-H cytology, a repeat colposcopy is recommended, and management based on resulting biopsies is recommended.'
      }
    when ( // 5
      AgeInYears() >= 25 and
      HistologyInterpretedAsCin1OrNormal and
      (
        PrecedingCytologyIsHsil or
        PrecedingCytologyIsAscH
      ) and
      not (
        MostRecentTreatmentDate 1 year or less after MostRecentBiopsyReport.date
      ) and
      (
        (
          CytologyInterpretedAsHsil and
          MostRecentCytologyReport.date 1 year or more after MostRecentBiopsyReport.date and
          MostRecentCytologyReport.date less than 3 years after MostRecentBiopsyReport.date
        ) or
        (
          CytologyInterpretedAsAscH and
          MostRecentCytologyReport.date 2 years or more after MostRecentBiopsyReport.date and
          MostRecentCytologyReport.date less than 3 years after MostRecentBiopsyReport.date
        )
      )
    ) then
      {
        action: null,
        text: 'A diagnostic excisional procedure is recommended for patients with HSIL cytology results at either the 1- or 2-year visit, or ASC-H results that persist at the 2-year visit (CIII).'
      }
    // I.5 Histologic LSIL (CIN1) Diagnosed Repeatedly for at Least 2 Years
    when (
      AgeInYears() >= 25 and
      MostRecentBiopsyReportWasWithinPast12months and
      HistologyInterpretedAsCin1 and
      SecondMostRecentHistologyInterpretedAsCin1 and
      TwoMostRecentBiopsyReportsWithin15monthsApart
    ) then
      {
        action: null,
        text: 'For patients 25 years or older with histologic LSIL (CIN 1) who is diagnosed at consecutive visits for at least 2 years, observation is preferred (BII) but treatment is acceptable (CIII). If treatment is selected and the entire squamocolumnar junction and all lesions were fully visualized during colposcopic examination, either excision or ablation treatments are acceptable (CII).'
      }
    // I.6 Management of AIS: Adoption of Society of Gynecologic Oncology Recommendations
    when (
      AgeInYears() >= 25 and
      MostRecentBiopsyReportWasWithinPastYear and
      HistologyInterpretedAsAis
    ) then
      {
        action: null,
        text: 'A diagnostic excisional procedure is recommended for all patients with a diagnosis of AIS on cervical biopsy to rule out invasive adenocarcinoma, even when definitive hysterectomy is planned. Excisional procedures should optimally remove an intact specimen to facilitate accurate interpretation of margin status. Although there is no preference for cold knife conization versus LEEP, intentional disruption of the specimen by performance of a LEEP followed by a “top hat” endocervical excision to achieve the desired specimen length is unacceptable. An excisional specimen length of at least 10 mm is preferred, and this can be increased to 18 to 20 mm for patients who are not concerned about the effect of treatment on future pregnancy. These dimensions are preferred regardless of whether hysterectomy is planned. After the initial diagnostic procedure, hysterectomy is the preferred management for all patients who have a histologic diagnosis of AIS, although fertility-sparing management for appropriately selected patients is acceptable. For patients with confirmed AIS with negative margins on the excisional specimen, simple hysterectomy is preferred. For patients with confirmed AIS with positive margins on the excisional specimen, re-excision to achieve negative margins is preferred, even if hysterectomy is planned. For patients with AIS and persistent positive margins for whom additional excisional procedures are not feasible, either a simple or modified radical hysterectomy is acceptable. After hysterectomy, surveillance per the ASCCP surveillance guidelines for treated CIN 2+ is recommended (Section J.3).\n\nFor patients of reproductive age who desire future pregnancy, fertility-sparing management with an excisional procedure is acceptable provided that negative margins have been achieved on the excisional specimen, and the patient is willing and able to adhere to surveillance recommendations. If negative margins cannot be achieved after maximal excisional attempts, fertility-sparing management is not recommended. For patients who undergo fertility-sparing management, surveillance with cotesting and endocervical sampling is recommended every 6 months for at least 3 years, then annually for at least 2 years, or until hysterectomy is performed. For patients who have consistently negative cotesting and endocervical sampling results for 5 years, extending the surveillance interval to every 3 years starting in the sixth year of surveillance is acceptable. Small retrospective studies have shown HPV test results to be the best predictor for recurrent disease. Therefore, for patients who have consistently negative cotesting and endocervical sampling results, continued surveillance is acceptable after completion of childbearing. For patients who have had positive HPV test results or abnormal cytology/histologic results during surveillance, hysterectomy at the completion of childbearing is preferred (see Figure 11).'
      }
    else
      null
  end

/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
// RARE ABNORMALITY #4: Surveillance After Abnormalities

define MostRecentTreatment:
  C3F.MostRecentProcedure(
    Dash.CervicalExcisionProcedures union
    Dash.CervicalAblationProcedures
  )

define MostRecentTreatmentDate:
  Common.ProcedureDate(MostRecentTreatment)

define TreatmentInLastYear:
  MostRecentTreatment P
  where Common.ProcedureDate(P) >= Now() - 12 months

define HasTreatmentInLastYear:
  TreatmentInLastYear is not null

define AnyHistologicHsil:
  (SortedBiopsyReports) B
    where AnyTrue(
      (B.allConclusions) aC
        return
          aC ~ Dash."CIN2" or
          aC ~ Dash."CIN3" or
          aC ~ Dash."HSIL, Unspecified"
    )

define HistologyInterpretedAsHistologicHsil:
  HistologyInterpretedAsCin2 or
  HistologyInterpretedAsCin3 or
  HistologyInterpretedAsUnspecifiedHsil

define SecondMostRecentHistologyInterpretedAsCin2:
  AnyTrue(
    (SecondMostRecentBiopsyReport.allConclusions) aC
      return
        aC ~ Dash."CIN2"
  )

define SecondMostRecentHistologyInterpretedAsCin3:
  AnyTrue(
    (SecondMostRecentBiopsyReport.allConclusions) aC
      return
        aC ~ Dash."CIN3"
  )

define SecondMostRecentHistologyInterpretedAsUnspecifiedHsil:
  AnyTrue(
    (SecondMostRecentBiopsyReport.allConclusions) aC
      return
        aC ~ Dash."HSIL, Unspecified"
  )

define SecondMostRecentHistologyInterpretedAsHistologicHsil:
  SecondMostRecentHistologyInterpretedAsCin2 or
  SecondMostRecentHistologyInterpretedAsCin3 or
  SecondMostRecentHistologyInterpretedAsUnspecifiedHsil

define HistologicHsilWithin12MonthsBeforeTreatment:
  AnyHistologicHsil B
  where
    B.date 12 months or less before MostRecentTreatmentDate

define HasHistologicHsilWithin12MonthsBeforeTreatment:
  Exists(HistologicHsilWithin12MonthsBeforeTreatment)

define PositiveHrHpvTestAfterTreatment:
  MostRecentHpvReport.date >= Now() - 12 months and
  MostRecentHpvReport.date 12 months or less after MostRecentTreatmentDate and
  AnyTrue(
    (MostRecentHpvReport.allConclusions) aC
      return
        aC ~ Dash."Positive HPV Finding"
  )

define RareAbnormalityHighGradeHistology:
  (SortedBiopsyReports) B
    where AnyTrue(
      (B.allConclusions) aC
        return
          aC ~ Dash."CIN2" or
          aC ~ Dash."CIN3" or
          aC ~ Dash."HSIL, Unspecified" or
          aC in Dash."AIS"
    )

define RareAbnormalityHighGradeHistologyBeforeTreatment:
  if (MostRecentTreatment is not null) then
    RareAbnormalityHighGradeHistology C
    where
      C.date 12 months or less before MostRecentTreatmentDate
  else
    null

define CytologicHsilOrAgc:
  (SortedCytologyReports) C
    where AnyTrue(
      (C.allConclusions) aC
        return
          aC in "HSIL" or
          aC ~ "AGC"
    )

define CytologicHsilOrAgcBeforeTreatment:
  if (MostRecentTreatment is not null) then
    CytologicHsilOrAgc C
    where
      C.date 12 months or less before MostRecentTreatmentDate
  else
    null

define CytologyResultsBeforeTreatment:
  if (MostRecentTreatment is not null) then
    (SortedCytologyReports) C
    where
      C.date 12 months or less before MostRecentTreatmentDate
  else
    null

define HasPersistentAscHBeforeTreatment:
  if Count(CytologyResultsBeforeTreatment) >= 2 then
    AnyTrue(
      (CytologyResultsBeforeTreatment[0].allConclusions) aC
        return aC ~ "ASC-H"
    ) and
    AnyTrue(
      (CytologyResultsBeforeTreatment[1].allConclusions) aC
        return aC ~ "ASC-H"
    )
  else
    false

define TreatmentForHighGradeHistologyOrCytology:
  if (MostRecentTreatment is not null) and
    (
      Exists(RareAbnormalityHighGradeHistologyBeforeTreatment) or
      Exists(CytologicHsilOrAgcBeforeTreatment) or
      HasPersistentAscHBeforeTreatment
    ) then
    MostRecentTreatment
  else
    null

define HasTreatmentForHighGradeHistologyOrCytology:
  TreatmentForHighGradeHistologyOrCytology is not null

define TreatmentForHighGradeHistologyOrCytologyDate:
  Common.ProcedureDate(TreatmentForHighGradeHistologyOrCytology)

define NegativeHrHpvTests:
  SortedHpvReports R
    where AnyTrue(
      (R.allConclusions) aC
        return
          aC ~ Dash."Negative HPV Finding" or
          aC ~ Dash."Negative"
    )

define NegativeHrHpvTestsAsPartOfCotest:
  from NegativeHrHpvTests H, SortedCytologyReports C
    where H.date within 1 day of C.date
    return H

define NegativePrimaryHrHpvTests:
  NegativeHrHpvTests except NegativeHrHpvTestsAsPartOfCotest

define NegativeCytologyTests:
  SortedCytologyReports R
    where AnyTrue(
      (R.allConclusions) aC
        return
          aC ~ Dash."NILM"
    )

define NegativeCotests:
  from NegativeHrHpvTests H, NegativeCytologyTests C
    where H.date within 1 day of C.date
    return H

define NegativeSurveillanceTests:
  (
    NegativePrimaryHrHpvTests union
    NegativeCotests
  )

define SortedNegativeSurveillanceTests:
  NegativeSurveillanceTests H
    where H.date is not null
    return {
      date: H.date
    }
    sort by date asc

define NegativeSurveillanceTestsAfterMostRecentBiopsy:
  SortedNegativeSurveillanceTests H
    where H.date > MostRecentBiopsyReport.date

define FirstNegativeSurveillanceTestAfterMostRecentBiopsy:
  if Count(NegativeSurveillanceTestsAfterMostRecentBiopsy) > 0 then
    NegativeSurveillanceTestsAfterMostRecentBiopsy[0]
  else
    null

define HasFirstNegativeSurveillanceTestAfterMostRecentBiopsy:
  FirstNegativeSurveillanceTestAfterMostRecentBiopsy is not null

define NegativeSurveillanceTestsAfterSecondMostRecentBiopsy:
  SortedNegativeSurveillanceTests H
    where H.date > SecondMostRecentBiopsyReport.date

define FirstNegativeSurveillanceTestAfterSecondMostRecentBiopsy:
  if Count(NegativeSurveillanceTestsAfterSecondMostRecentBiopsy) > 0 then
    NegativeSurveillanceTestsAfterSecondMostRecentBiopsy[0]
  else
    null

define HasFirstNegativeSurveillanceTestAfterSecondMostRecentBiopsy:
  FirstNegativeSurveillanceTestAfterSecondMostRecentBiopsy is not null

define NegativeSurveillanceTestsAfterTreatmentForHighGradeHistologyOrCytology:
  if HasTreatmentForHighGradeHistologyOrCytology then
    SortedNegativeSurveillanceTests T
    where T.date > TreatmentForHighGradeHistologyOrCytologyDate
  else
    null

define InitialIntensiveSurveillancePeriod:
  if Count(NegativeSurveillanceTestsAfterTreatmentForHighGradeHistologyOrCytology) >= 4 then
    (
      NegativeSurveillanceTestsAfterTreatmentForHighGradeHistologyOrCytology[0].date 3 years or more before NegativeSurveillanceTestsAfterTreatmentForHighGradeHistologyOrCytology[2].date and
      NegativeSurveillanceTestsAfterTreatmentForHighGradeHistologyOrCytology[0].date 5 years or less before NegativeSurveillanceTestsAfterTreatmentForHighGradeHistologyOrCytology[2].date
    ) or
    (
      NegativeSurveillanceTestsAfterTreatmentForHighGradeHistologyOrCytology[1].date 3 years or more before NegativeSurveillanceTestsAfterTreatmentForHighGradeHistologyOrCytology[3].date and
      NegativeSurveillanceTestsAfterTreatmentForHighGradeHistologyOrCytology[1].date 5 years or less before NegativeSurveillanceTestsAfterTreatmentForHighGradeHistologyOrCytology[3].date
    )
  else
    false

define RecommendationForSurveillanceAfterAbnormalities:
  case
    // J.2 Short-Term Follow-up After Treatment for Histologic HSIL
    when ( // 1
      HasTreatmentInLastYear and
      HasHistologicHsilWithin12MonthsBeforeTreatment
    ) then
      {
        action: null,
        text: 'After treatment, hrHPV-based testing is preferred at 6 months regardless of the margin status of the excisional specimen (BII). hrHPV-based testing includes cotesting and primary hrHPV testing. Follow-up at 6 months with colposcopy and ECC is acceptable (BIII). When margins are positive for CIN 2+ or ECC performed at the time of the excisional procedure shows CIN 2+ in patients 25 years or older who are not concerned about the potential effect of treatment on future pregnancy outcomes, repeat excision or observation is acceptable. For observation, HPV-based testing in 6 months is preferred; it is also acceptable to perform a colposcopy and ECC at 6 months.'
      }
    when ( // 2
      PositiveHrHpvTestAfterTreatment and
      HasHistologicHsilWithin12MonthsBeforeTreatment
    ) then
      {
        action: null,
        text: 'Colposcopy and appropriate biopsies should be performed if an hrHPV “positive” result after treatment for histologic HSIL (AIII).'
      }
    when ( // 3
      HistologyInterpretedAsHistologicHsil and
      MostRecentBiopsyReport.date 5 years or less after MostRecentTreatmentDate and
      SecondMostRecentHistologyInterpretedAsHistologicHsil and
      SecondMostRecentBiopsyReport.date 5 years or less before MostRecentTreatmentDate
    ) then
      {
        action: null,
        text: 'If recurrent histologic HSIL (CIN 2+) develops after excisional treatment, and repeat excision is not feasible or not desired, hysterectomy is recommended.'
      }
    // J.3 Guidance for Long-Term Follow-up After Treatment for High-Grade Histology or Cytology
    when ( // 1
      HasTreatmentForHighGradeHistologyOrCytology and
      TreatmentForHighGradeHistologyOrCytologyDate >= Now() - 25 years and
      not InitialIntensiveSurveillancePeriod
    ) then
      {
        action: null,
        text: 'In patients treated for histologic or cytologic HSIL, after the initial HPV-based test at 6 months, annual HPV or cotesting is preferred until 3 consecutive negative tests have been obtained (AII). Discontinuation of screening is recommended if a patient has a limited life expectancy. Management according to the highest-grade abnormality found on histology or cytology is recommended.'
      }
    when ( // 2
      HasTreatmentForHighGradeHistologyOrCytology and
      TreatmentForHighGradeHistologyOrCytologyDate >= Now() - 25 years and
      InitialIntensiveSurveillancePeriod
    ) then
      {
        action: null,
        text: 'In patients treated for histologic or cytologic HSIL, after the initial intensive surveillance period, continued surveillance at 3-year intervals is recommended for at least 25 years after treatment of high-grade histology (histologic HSIL, CIN 2, CIN 3, or AIS) or high-grade cytology (HSIL, AGC, or persistent ASC-H) even if this is beyond the age of 65 years (BII). When patients with a history of treated high-grade histology or cytology reach the age of 65 years, if they have completed the initial 25-year surveillance period, continued surveillance at 3-year intervals is acceptable and may continue as long as the patient is in reasonably good health (BIII). Discontinuation of screening is recommended if a patient has a limited life expectancy. Management according to the highest-grade abnormality found on histology or cytology is recommended.'
      }
    else
      null
  end

define RareAbnormalityRecommendation:
  Coalesce(
    RecommendationForSurveillanceAfterAbnormalities,
    RecommendationForHistologyResults,
    RecommendationForExceptionsToColposcopyThreshold,
    RecommendationForRareCytology
  )

define WhichRarityMadeTheRecommendation:
  case
    when RecommendationForSurveillanceAfterAbnormalities is not null then 4
    when RecommendationForHistologyResults is not null then 3
    when RecommendationForExceptionsToColposcopyThreshold is not null then 2
    when RecommendationForRareCytology is not null then 1
    else null
  end

//------------------------------------------------------------------------------
// RECOMMENDATIONS FOR SPECIAL POPULATIONS
//------------------------------------------------------------------------------

/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
// Special Populations Section K.1 Management of Patients Younger Than 25 Years

define CytologyInterpretedAsLsil:
  AnyTrue(
    (MostRecentCytologyReport.allConclusions) aC
      return aC ~ "LSIL"
  )

define CytologyInterpretedAsAscus:
  AnyTrue(
    (MostRecentCytologyReport.allConclusions) aC
      return aC ~ "ASC-US"
  )

define CytologyInterpretedAsHsil:
  AnyTrue(
    (MostRecentCytologyReport.allConclusions) aC
      return aC in "HSIL"
  )

define SecondMostRecentCytologyInterpretedAsLsil:
  AnyTrue(
    (SecondMostRecentCytologyReport.allConclusions) aC
      return aC ~ "LSIL"
  )

define SecondMostRecentCytologyInterpretedAsAscus:
  AnyTrue(
    (SecondMostRecentCytologyReport.allConclusions) aC
      return aC ~ "ASC-US"
  )

define AssociatedHpvCotest:
  Coalesce(
    (SortedHpvReports) H
      where H.date within 1 day of SecondMostRecentCytologyReport.date
  )

define ColposcopySinceMostRecentCytology:
  Exists(
    (Dash.ColposcopyProcedures) P
      where Common.ProcedureDate(P) >= MostRecentCytologyReport.date
  )

define HistologicHsilCin2OrUnspecified:
  First(
    (SortedBiopsyReports) B
    where AnyTrue(
      (B.allConclusions) aC
        return
          aC ~ Dash."CIN2" or
          aC ~ Dash."HSIL, Unspecified"
    )
  )

define SubsequentLowGradeHistologyReportsSinceMostRecentHsilHistology:
  (SortedBiopsyReports) B
    where
      B.date less than 2 years after HistologicHsilCin2OrUnspecified.date and
      AnyTrue(
        (B.allConclusions) aC
          return
            aC ~ "CIN1" or
            aC ~ "Biopsy Normal"
      )

define SubsequentLowGradeCytologyReportsSinceMostRecentHsilHistology:
  (SortedCytologyReports) C
    where
      C.date less than 2 years after HistologicHsilCin2OrUnspecified.date and
      AnyTrue(
        (C.allConclusions) aC
          return
            aC ~ Dash."NILM" or
            aC ~ "LSIL" or
            aC ~ "ASC-US"
      )

define Under25AndLowGradeCytologyResults:
  AgeInYears() < 25 and
  (
    CytologyInterpretedAsLsil or
    (
      MostRecentCytologyCotestResult = 'ASC-US' and
      MostRecentHpvResult = 'HPV-positive'
    ) or
    (
      CytologyInterpretedAsAscus and
      MostRecentCytologyCotestResult is null
    )
  )

define TwoMostRecentCytologyReports2To3YearsApart:
  SecondMostRecentCytologyReport.date 2 years or more before MostRecentCytologyReport.date and
  SecondMostRecentCytologyReport.date 3 years or less before MostRecentCytologyReport.date

define Under25AndSecondMostRecentLowGradeCytologyResults:
  AgeInYears() < 25 and
  (
    SecondMostRecentCytologyInterpretedAsLsil or
    (
      SecondMostRecentCytologyInterpretedAsAscus and
      AssociatedHpvCotest.riskTableInput = 'HPV-positive'
    ) or
    (
      SecondMostRecentCytologyInterpretedAsAscus and
      AssociatedHpvCotest is null
    )
  )

define HistologyInterpretedAsLessThanCin2AfterAbnormalCytologyScreening:
  HistologyInterpretedAsCin1OrNormal and
  Under25AndLowGradeCytologyResults and
  Under25AndSecondMostRecentLowGradeCytologyResults and
  MostRecentBiopsyReport.date 3 years or less after MostRecentCytologyReport.date

define CytologyInterpretedAsAscusOrAbove:
  MostRecentCytologyReport.riskTableInput in {'ASC-US','LSIL','ASC-H','AGC','HSIL+'}

define SecondMostRecentCytologyInterpretedAsAscHOrHsil:
  AnyTrue(
    (SecondMostRecentCytologyReport.allConclusions) aC
      return
        aC ~ "ASC-H" or
        aC in "HSIL"
  )

define BiopsySinceMostRecentCytology:
  Exists(
    SortedBiopsyReports B
    where B.date > MostRecentCytologyReport.date
  )

define RecommendationForPatientsYoungerThan25:
  case
    // Heading 1 & Heading 2: Initial Management After an Abnormal Screening Test Result; Management of Cytology ASC-H and HSIL in Patients Younger than 25 Years
    when ( // 1
      Under25AndLowGradeCytologyResults
    ) then
      {
        action: 'Cytology',
        text: 'Repeat cytology alone at one and two years is recommended after an initial low-grade cytology screening result of LSIL, ASC-US HPV-positive, or ASC-US result without HPV testing (BII). Clinicians should switch to using risk estimates when patients reach the age of 25 years.'
      }
    when ( // 2
      AgeInYears() < 25 and
      MostRecentCytologyReportWasWithinPastFiveYears and
      (
        CytologyInterpretedAsHsil or
        CytologyInterpretedAsAscH or
        CytologyInterpretedAsAgc or
        CytologyInterpretedAsAis
      ) and
      not BiopsySinceMostRecentCytology

    ) then
      {
        action: 'Colposcopy',
        text: 'Colposcopy is recommended for individuals under 25 years old with cytologic HSIL, ASC-H, AGC or AIS (BII). Immediate treatment without histologic confirmation is not recommended for cytology HSIL or ASC-H. Clinicians should switch to using risk estimates when patients reach the age of 25 years.'
      }
    when ( // 3
      Under25AndLowGradeCytologyResults and
      Under25AndSecondMostRecentLowGradeCytologyResults
      and TwoMostRecentCytologyReports2To3YearsApart
    ) then
      {
        action: 'Colposcopy', // NOTE: Do we want to continue adding 'actions' to the Rare Abnormality recommendations?
        text: 'Colposcopy is recommended if low-grade cytology persists at the 2-year follow up visit after low-grade cytology results (BII). Clinicians should switch to using risk estimates when patients reach the age of 25 years.'
      }
    when ( // 4
      AgeInYears() < 25 and
      MostRecentCytologyReportWasWithinPastFiveYears and
      MostRecentCytologyCotestResult = 'ASC-US' and
      MostRecentHpvResult = 'HPV-negative'
    ) then
      {
        action: 'Cytology',
        text: 'Cervical Cytology test (alone) is indicated 3 years after an ASC-US/HPV-Negative result. Clinicians should switch to using risk estimates when patients reach the age of 25 years.'
      }
    when ( // 5a
      HistologyInterpretedAsLessThanCin2AfterAbnormalCytologyScreening and
      MostRecentBiopsyReport.date > Now() - 12 months
    ) then
      {
        action: null,
        text: 'For patients under 25 years old perform cervical cytology one year following cervical histologic LSIL(CIN1) or <CIN1 result. (BIII). Clinicians should switch to using risk estimates when patients reach the age of 25 years.'
      }
    when ( // #5b
      HistologyInterpretedAsLessThanCin2AfterAbnormalCytologyScreening and
      MostRecentBiopsyReport.date <= Now() - 12 months and
      not (MostRecentCytologyReport.date > MostRecentBiopsyReport.date)
    ) then
      {
        action: null,
        text: 'This patient is due now for cervical cytology screening. For patients under 25 years old, cervical cytology should be performed one year after a cervical histologic LSIL(CIN1) or <CIN1 result. (BIII). Clinicians should switch to using risk estimates when patients reach the age of 25 years.'
      }
    // Heading 3: Management of Histology of Less than CIN2 Preceded by Cytology ASC-H and HSIL in Patients Younger than 25 Year
    when ( // 1b
      AgeInYears() < 25 and
      HistologyInterpretedAsCin1OrNormal and
      CytologyInterpretedAsHsil and
      MostRecentCytologyReport.date less than 12 months before MostRecentBiopsyReport.date
    ) then
      {
        action: null,
        text: 'Observation is recommended with colposcopy and cytology at 1 and 2 years following a cervical histology result of CIN1 or <CIN1 preceded by a HSIL cytology. Diagnostic excisional procedures are not recommended for patients younger than 25 years with these results as long as the squamocolumnar junction and the upper limit of all lesions are fully visualized, the endocervical sampling is less than CIN 2, and review of histology/cytology does not change the diagnosis. Clinicians should switch to using risk estimates when patients reach the age of 25 years.'
      }
    when ( // 1c
      AgeInYears() < 25 and
      HistologyInterpretedAsCin1OrNormal and
      CytologyInterpretedAsAscH and
      MostRecentCytologyReport.date less than 12 months before MostRecentBiopsyReport.date
    ) then
      {
        action: null,
        text: 'Observation is recommended with cytology at 1 and 2 years following a cervical histology result of CIN1 or <CIN1 preceded by a ASC-H, AGC or AIS cytology. Diagnostic excisional procedures are not recommended for patients younger than 25 years with these results as long as the squamocolumnar junction and the upper limit of all lesions are fully visualized, the endocervical sampling is less than CIN 2, and review of histology/cytology does not change the diagnosis. Clinicians should switch to using risk estimates when patients reach the age of 25 years.'
      }
    when ( // 2
      AgeInYears() >= 21 and AgeInYears() < 25 and
      HistologyInterpretedAsCin1OrNormal and
      (
        CytologyInterpretedAsAscusOrAbove or
        CytologyInterpretedAsAis
      ) and
      MostRecentCytologyReport.date less than 3 years after MostRecentBiopsyReport.date and
      SecondMostRecentCytologyInterpretedAsAscHOrHsil and
      SecondMostRecentCytologyReport.date less than 6 months before MostRecentBiopsyReport.date
    ) then
      {
        action: null,
        text: 'Colposcopy is recommended for cytologic ASC-US or above on repeat testing following a CIN1 or < CIN1 result that is preceded by a cytologic ASC-H, AGC, AIS, or HSIL result. Clinicians should switch to using risk estimates when patients reach the age of 25 years.'
      }
    when ( // 3
      AgeInYears() < 25 and
      not Pregnant and
      HistologyInterpretedAsCin1OrNormal and
      (
        CytologyInterpretedAsHsil or
        CytologyInterpretedAsAscH
      ) and
      MostRecentCytologyReport.date more than 18 months after MostRecentBiopsyReport.date and
      MostRecentCytologyReport.date less than 3 years after MostRecentBiopsyReport.date
    ) then
      {
        action: null,
        text: 'If a high-grade cytologic abnormality (HSIL, ASC-H) without histologic HSIL persists for 2 years, a diagnostic excisional procedure is recommended (unless the patient is pregnant). A diagnostic excisional procedure is recommended in patients when the squamocolumnar junction or the upper limit of all lesions are not fully visualized.'
      }
    // Heading 4: Management of Histologic HSIL (CIN2 or CIN3) for Patients Younger Than 25 Years
    when ( // 1
      AgeInYears() < 25 and
      MostRecentBiopsyReportWasWithinPastYear and
      HistologyInterpretedAsCin3
    ) then
      {
        action: 'Treatment',
        text: 'Treatment is recommended, and observation is unacceptable (EII)'
      }
    when ( // 2
      AgeInYears() < 25 and
      MostRecentBiopsyReportWasWithinPastYear and
      HistologyInterpretedAsCin2
    ) then
      {
        action: null,
        text: 'Observation is preferred, and treatment is acceptable (BII). Observation includes colposcopy and cytology at 6-month intervals.'
      }
    when ( // 3
      AgeInYears() < 25 and
      MostRecentBiopsyReportWasWithinPastYear and
      HistologyInterpretedAsUnspecifiedHsil
    ) then
      {
        action: null,
        text: 'Observation or treatment is acceptable after an unspecified histologic HSIL result. Observation includes colposcopy and cytology at 6-month intervals.'
      }
    when ( // 4
      AgeInYears() < 25 and
      HistologicHsilCin2OrUnspecified is not null and
      Count(SubsequentLowGradeHistologyReportsSinceMostRecentHsilHistology) >= 2 and
      Count(SubsequentLowGradeCytologyReportsSinceMostRecentHsilHistology) >= 2
    ) then
      {
        action: null,
        text: 'Surveillance with colposcopy and cervical cytology should be performed at 1 year after the most recent cervical histology and cytology tests following an earlier histology HSIL (CIN2) or histologic HSIL, unspecified result.'
      }
    when ( // 5
      AgeInYears() < 25 and
      (
        HistologyInterpretedAsCin2 or
        HistologyInterpretedAsUnspecifiedHsil
      ) and
      (
        SecondMostRecentHistologyInterpretedAsCin2 or
        SecondMostRecentHistologyInterpretedAsUnspecifiedHsil
      ) and
      SecondMostRecentBiopsyReport.date within 2 years of MostRecentBiopsyReport.date
    ) then
      {
        action: 'Treatment',
        text: 'Treatment is recommended. Excisional treatment is recommended when the squamocolumnar junction or the lesions(s) are not fully visualized.'
      }
    else
      null
  end

/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
// Special Populations Section K.2 Management of Patients During Pregnancy

define PregnancyOnset:
  Coalesce(
    Common.Onset(
      C3F.MostRecentCondition(
        Dash.PregnancyDiagnoses
      )
    ),
    Common.ObservationDate(
      C3F.MostRecent(
        Dash.PregnancyObservations
      )
    )
  ) as System.Date

define FirstHistologyAfterPregnancyOnset:
  Last(
    (SortedBiopsyReports) B
      where B.date >= PregnancyOnset
  )

define HistologicAisDuringPregnancy:
  Exists(
    (SortedBiopsyReports) B
      where
        B.date >= PregnancyOnset and
        B.date <= PregnancyOnset + 42 weeks and
        AnyTrue(
          (B.allConclusions) aC
            return
              aC in Dash."AIS"
        )
  )

define RecommendationForPregnantPatients:
  case
    // #1 is covered by the Common Abnormality Recommendation section.
    when ( // 2 - Recommendation #1
      AgeInYears() >= 25 and
      Pregnant and
      FirstHistologyAfterPregnancyOnset.date > Now() - 1 year and
      FirstHistologyAfterPregnancyOnset.riskTableInput in {'CIN2','CIN3'}
    ) then
      {
        action: null,
        text: 'Surveillance colposcopy and testing (with diagnostic cytology or HPV depending on age) is preferred every 12 to 24 weeks but deferring colposcopy to the postpartum period is acceptable (BII). In postpartum period, colposcopy is recommended no earlier than 4 weeks after delivery (BII). In patients diagnosed with histologic HSIL (CIN2 or CIN3) during pregnancy, if a lesion is detected at postpartum colposcopy, an excisional treatment procedure or full diagnostic evaluation (cervical cytology, HPV, and biopsy) is acceptable (BII). In the absence of a lesion on colposcopy, a full diagnostic evaluation is recommended/ expedited treatment is not recommended (BII).\n\nFor patients with a diagnosis of histologic HSIL (CIN 2) whose concerns about the effects of treatment on a future pregnancy outweigh their concerns about cancer, either observation or treatment is acceptable provided the squamocolumnar junction is visible and CIN 2+ or ungraded CIN is not identified on endocervical sampling (CII). If the histologic HSIL cannot be specified as CIN 2, treatment is preferred, but observation is acceptable if there are concerns related to future pregnancies (CIII). For patients 25 years or older, observation includes colposcopy and HPV-based testing with cotest or primary hrHPV testing at 6-month intervals for up to 2 years.'
      }
    when ( // 2 - Recommendation #2
      AgeInYears() >= 25 and
      Pregnant and
      HistologicAisDuringPregnancy
    ) then
      {
        action: null,
        text: 'Referral to a gynecologic oncologist is preferred if AIS is diagnosed during pregnancy, but management by a gynecologist skilled in the colposcopic diagnosis and treatment of AIS is acceptable (CIII).'
      }
    else
      null
  end

/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
// Special Populations Section K.3 Managing Patients With Immunosuppression

define Immunocompromised:
  Dash.Immunocompromised

define MostRecentHpvReportWasWithinPastFiveYears:
  MostRecentHpvReport.date > Now() - 5 years

define TwoMostRecentCytologyReportsWithin18MonthsApart:
  SecondMostRecentCytologyReport.date within 18 months of MostRecentCytologyReport.date

define RecommendationForImmunosuppressedPatients:
  case
    when ( // 1
      Immunocompromised and
      (
        (
          MostRecentHpvResult = 'HPV-positive' and
          MostRecentCytologyCotestResult = 'ASC-US' and
          MostRecentCytologyReportWasWithinPastFiveYears
        ) or
        (
          MostRecentCytologyReportWasWithinPastFiveYears and
          (
            MostRecentCytologyReport.riskTableInput in {'LSIL','ASC-H','AGC','HSIL+'} or
            CytologyInterpretedAsAis
          )
        ) or
        (
          MostRecentHpvResult in {'HPV16+','HPV16-, HPV18+'} and
          MostRecentHpvReportWasWithinPastFiveYears
        )
      )
    ) then
      {
        action: null,
        text: 'Colposcopy referral is recommended for immunocompromised patients of any age with cytology results of HPV-positive ASC-US or higher and for any cytology results of LSIL or worse.'
      }
    when ( // 2
      Immunocompromised and
      MostRecentCytologyReportWasWithinPastFiveYears and
      MostRecentCytologyReport.riskTableInput = 'ASC-US'
    ) then
      {
        action: null,
        text: 'Repeat cytology in 6 to 12 months when the patient is immunocompromised and is found to have cytologic ASC-US.'
      }
    when ( // 3
      Immunocompromised and
      MostRecentCytologyReportWasWithinPastFiveYears and
      (
        CytologyInterpretedAsAscusOrAbove or
        CytologyInterpretedAsAis
      ) and
      SecondMostRecentCytologyReport.riskTableInput = 'ASC-US' and
      TwoMostRecentCytologyReportsWithin18MonthsApart
    ) then
      {
        action: null,
        text: 'Colposcopy is recommended when the patient is immunocompromised and is found to have cytologic ASC-US or higher or HPV positive after a cytologic ASC-US result.'
      }
    else
      null
  end

/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
// Special Populations Section K.4 Managing Patients After Hysterectomy

define MostRecentCervixRemovalProcedureDate:
  Common.ProcedureDate(
    C3F.MostRecentProcedure(
      Dash.RemovalOfCervixProcedures
    )
  )

define CervixRemovalWithHighGradePrecancerOrCancerReasonCode:
  Dash.RemovalOfCervixProcedures P
    where AnyTrue(
      (P.reasonCode) rC
        return
          rC in Dash."Cervical Precancer Disorders" or
          rC in Dash."Diagnosis of Cervical cancer" or
          rC ~ Dash."CIN2" or
          rC ~ Dash."CIN3" or
          rC ~ Dash."HSIL, Unspecified" or
          rC in Dash."AIS" or
          rC in Dash."Histologic cancer"
    )

define MostRecentCervixRemovalObservationDate:
  Common.ObservationDate(
    C3F.MostRecent(
      Dash.AbsenceOfCervixObservations
    )
  )

define MostRecentCervixRemovalDiagnosisDate:
  Common.Onset(
    C3F.MostRecentCondition(
      Dash.AbsenceOfCervixDiagnoses
    )
  )

define CervixRemovalDate:
  Coalesce(
    MostRecentCervixRemovalProcedureDate,
    MostRecentCervixRemovalObservationDate,
    MostRecentCervixRemovalDiagnosisDate
  )

define HighGradePreCancerCervicalLesionDate:
  if Exists(Dash.CervicalPrecancerDisorders) then
    {
      date: Common.ConditionDate(C3F.MostRecentCondition(Dash.CervicalPrecancerDisorders))
    }
  else
    null

define CervicalCancerDiagnosisDate:
  if Exists(Dash.CervicalCancerDiagnoses) then
    {
      date: Common.ConditionDate(C3F.MostRecentCondition(Dash.CervicalCancerDiagnoses))
    }
  else
    null

define HighGradeOrCancerHistologyResultsDate:
  if Exists(Dash.HighGradeOrCancerHistologyResults) then
    {
      date: Common.DiagnosticReportDate(Common.MostRecentDiagnosticReport(Dash.HighGradeOrCancerHistologyResults))
    }
  else
    null

define CauseForHysterectomyDates:
  {
    HighGradePreCancerCervicalLesionDate,
    CervicalCancerDiagnosisDate,
    HighGradeOrCancerHistologyResultsDate
  } except { null }

define SortedCauseForHysterectomyDates:
  CauseForHysterectomyDates D
  return D
  sort by date desc

define MostRecentCauseForHysterectomyDate:
  if Count(SortedCauseForHysterectomyDates) > 0 then
    SortedCauseForHysterectomyDates[0].date
  else
    null

define HysterectomyPerformedForTreatment:
    CervixRemovalDate 1 year or less after MostRecentCauseForHysterectomyDate or
    Exists(CervixRemovalWithHighGradePrecancerOrCancerReasonCode)

define NegativeSurveillanceTestsAfterHysterectomy: // NOTE: We should be able to refactor the LP4 Grade D Exclusions in a similar way
  SortedNegativeSurveillanceTests T
  where T.date >= CervixRemovalDate

define InitialIntensiveSurveillancePeriodPostHysterectomy:
  if Count(NegativeSurveillanceTestsAfterHysterectomy) >= 3 then
    NegativeSurveillanceTestsAfterHysterectomy[2].date less than 5 years after CervixRemovalDate
  else
    false

define RecommendationForManagingPatientsAfterHysterectomy:
  case
    when ( // 1
      CervixRemovalDate >= Now() - 25 years and
      HysterectomyPerformedForTreatment and
      not InitialIntensiveSurveillancePeriodPostHysterectomy
    ) then
      {
        action: null,
        text: 'Three annual hrHPV-based tests with cotest or primary hrHPV test are recommended after a hysterectomy is performed for treatment of a high-grade precancer or cancer.'
      }
    when ( // 2
      CervixRemovalDate >= Now() - 25 years and
      HysterectomyPerformedForTreatment and
      InitialIntensiveSurveillancePeriodPostHysterectomy
    ) then
      {
        action: null,
        text: 'HPV-based testing with cotest or primary hrHPV test is recommended every 3 years after a histologic HSIL (CIN2 or CIN3) or AIS results for 25 years, regardless of whether the patient has had a hysterectomy either for treatment or at any point during the surveillance period (CIII).'
      }
    else
      null
  end

/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
// Special Populations Section K.5 Managing Patients Older Than 65 Years With a History of Prior Abnormalities

define Over65RecommendationText:
  'If patients over age 65 years undergo HPV testing, cotesting, or cytology, management according to guidelines for patients aged 25 to 65 years is recommended (CII). If surveillance testing is recommended for either a history of abnormal screening results or treatment for precancer, discontinuing surveillance is unacceptable if the patient is in reasonably good health and testing is feasible (DII). Discontinuation of surveillance is recommended for patients with a limited life expectancy (EIII). This population will be managed based on logic defined for rare abnormalities and common abnormalities.'

define RecommendationForPatientsOlderThan65:
  // TODO: Re-word text here once edits are made to the Common Abnormalities section by the L2 team.
  case
    when (
      AgeInYears() > 65 and
      IsIncludedAndNotExcluded and
      ManagementRecommendationIsSurveillance
    ) then
      {
        action: CommonAbnormalityRecommendationText,
        text: CommonAbnormalityRecommendationText + ' is recommended.' + '\n\n' + J1RecommendationText + '\n\n' + Over65RecommendationText
      }
    when (
      AgeInYears() > 65 and
      IsIncludedAndNotExcluded and
      ManagementRecommendationIsColposcopyOrTreatment
    ) then
      {
        action: CommonAbnormalityRecommendationText,
        text: CommonAbnormalityRecommendationText + ' is recommended.' + '\n\n' + Over65RecommendationText
      }
    else
      null
  end

define SpecialPopulationRecommendation:
  Coalesce(
    RecommendationForPatientsYoungerThan25,
    RecommendationForPregnantPatients,
    RecommendationForImmunosuppressedPatients,
    RecommendationForManagingPatientsAfterHysterectomy,
    RecommendationForPatientsOlderThan65
  )

define WhichPopulationMadeTheRecommendation:
  case
    when RecommendationForPatientsYoungerThan25 is not null then 5
    when RecommendationForPregnantPatients is not null then 4
    when RecommendationForImmunosuppressedPatients is not null then 3
    when RecommendationForManagingPatientsAfterHysterectomy is not null then 2
    when RecommendationForPatientsOlderThan65 is not null then 1
    else null
  end

//------------------------------------------------------------------------------
// RECOMMENDATIONS FOR COMMON ABNORMALITIES
//------------------------------------------------------------------------------

/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
// COMMON ABNORMALITY #1: Abnormal Results
// Tables 1A and 1B
define LookUpTable1:
  RiskTableLookup.GetGeneralScreeningManagement(
    SecondMostRecentHpvResult,
    SecondMostRecentCytologyCotestResult,
    MostRecentHpvResult,
    MostRecentCytologyCotestResult
  )

define GeneralScreeningManagementRecommendation:
  if LookUpTable1 is not null then LookUpTable1
  else null

/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
// COMMON ABNORMALITY #2: Surveillance following results not requiring immediate colposcopic referral
// Tables 2A, 2B, and 2C
define LookUpTable2: // NOTE: Review whether we are correctly handling the multiple negative cotests referenced in Table 2b and 2c
  RiskTableLookup.GetSurveillanceManagement(
    ThirdMostRecentHpvResult,
    ThirdMostRecentCytologyCotestResult,
    SecondMostRecentHpvResult,
    SecondMostRecentCytologyCotestResult,
    MostRecentHpvResult,
    MostRecentCytologyCotestResult
  )

define SurveillanceManagementRecommendation:
  if LookUpTable2 is not null then LookUpTable2
  else null

/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
// COMMON ABNORMALITY #3: Receipt of colposcopy/biopsy results
// Table 3
define LookUpTable3: // NOTE: Review whether we need to look at history going further back
  RiskTableLookup.GetColposcopyResultsManagement(
    ReferringHpvResult,
    ReferringCytologyResult,
    MostRecentBiopsyResult
  )

define ColposcopyResultsManagementRecommendation:
  if LookUpTable3 is not null then LookUpTable3
  else null

/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
// COMMON ABNORMALITY #4: Surveillance visit following colposcopy/biopsy finding less than CIN 2
// Tables 4A and 4B
define LookUpTable4:
  RiskTableLookup.GetPostColposcopyManagement(
    ReferringHpvResult,
    ReferringCytologyResult,
    MostRecentBiopsyResult,
    ThirdMostRecentHpvResultPostBiopsy,
    ThirdMostRecentCytologyResultPostBiopsy,
    SecondMostRecentHpvResultPostBiopsy,
    SecondMostRecentCytologyResultPostBiopsy,
    MostRecentHpvResultPostBiopsy,
    MostRecentCytologyResultPostBiopsy
  )

define PostColposcopyManagementRecommendation:
  if LookUpTable4 is not null then LookUpTable4
  else null

/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
// COMMON ABNORMALITY #5: Follow-up after treatment for CIN2 or CIN 3
// Tables 5A and 5B
define LookUpTable5:
  RiskTableLookup.GetPostTreatmentManagement(
    MostRecentBiopsyResult,
    ThirdMostRecentHpvResultAfterTreatment,
    ThirdMostRecentCytologyResultAfterTreatment,
    SecondMostRecentHpvResultAfterTreatment,
    SecondMostRecentCytologyResultAfterTreatment,
    MostRecentHpvResultAfterTreatment,
    MostRecentCytologyResultAfterTreatment
  )

define PostTreatmentManagementRecommendation:
  if LookUpTable5 is not null then LookUpTable5
  else null

define CommonAbnormalityRecommendationText:
  Coalesce(
    PostTreatmentManagementRecommendation,
    PostColposcopyManagementRecommendation,
    ColposcopyResultsManagementRecommendation,
    SurveillanceManagementRecommendation,
    GeneralScreeningManagementRecommendation
  )

define WhichTableMadeTheRecommendation:
  case
    when PostTreatmentManagementRecommendation is not null then 5
    when PostColposcopyManagementRecommendation is not null then 4
    when ColposcopyResultsManagementRecommendation is not null then 3
    when SurveillanceManagementRecommendation is not null then 2
    when GeneralScreeningManagementRecommendation is not null then 1
    else null
  end

define ManagementRecommendationIsSurveillance:
  CommonAbnormalityRecommendationText in {'5-year follow-up','3-year follow-up','1-year follow-up'}

define ManagementRecommendationIsColposcopyOrTreatment:
  CommonAbnormalityRecommendationText in {'Colposcopy','Colposcopy/Treatment','Treatment'}

define J1RecommendationText:
  'After abnormal cervical cancer screening test results for patients 25 years or older, colposcopic biopsy results, or treatment of histologic HSIL, surveillance with either HPV testing alone or cotesting is preferred (AI). Surveillance with cervical cytology alone is acceptable only if testing with HPV or cotesting is not feasible (CIII). Cytology is recommended at 6-month intervals when 1-year intervals are recommended for HPV or cotesting, and annually when 3-year intervals are recommended for HPV or cotesting (AII).'

define TreatmentWithPregnancyConcernsRecommendationText:
  'Endocervical curettage, endometrial biopsy, and treatment without biopsy are unacceptable during pregnancy (EIII). A diagnostic excisional procedure or repeat biopsy is recommended only if cancer is suspected based on cytology, colposcopy, or histology (BII).\n\nFor patients with a diagnosis of histologic HSIL (CIN 2) whose concerns about the effects of treatment on a future pregnancy outweigh their concerns about cancer, either observation or treatment is acceptable provided the squamocolumnar junction is visible and CIN 2+ or ungraded CIN is not identified on endocervical sampling (CII). If the histologic HSIL cannot be specified as CIN 2, treatment is preferred, but observation is acceptable if there are concerns related to future pregnancies (CIII). For patients 25 years or older, observation includes colposcopy and HPV-based testing with cotest or primary hrHPV testing at 6-month intervals for up to 2 years.'

define OneYearSurveillanceRecommendationText:
  'When patients have an estimated risk of CIN 3+ based on history and current results that is below the threshold for immediate colposcopy (4.0% immediate risk) and above the 3-year follow-up threshold (≥0.55% at 5 years), repeat testing in 1 year with HPV-based testing is recommended (AII).'

define ThreeYearSurveillanceRecommendationText:
  'When patients have an estimated 5-year CIN 3+ risk of 0.15% or greater but less than 0.55% based on history and current test results, repeat testing in 3 years with HPV-based testing is recommended (AII).'

define FiveYearSurveillanceRecommendationText:
  'When patients have an estimated 5-year CIN 3+ risk of less than 0.15% based on past history and current test results, return to routine screening at 5-year intervals using HPV-based testing is recommended (AII).'

define ColposcopyRecommendationText:
  'When patients have an estimated immediate risk of diagnosis of CIN 3+ of 4.0% or greater based on history and current results, referral to colposcopy is recommended (AII).'

define ColposcopyOrTreatmentRecommendationText:
  'For nonpregnant patients 25 years or older with an estimated immediate risk of CIN 3+ 25% or greater and less than 60% based on history and current results, treatment using an excisional procedure without previous biopsy confirmation or histologic evaluation with colposcopy and biopsy are both acceptable (AII).'

define TreatmentRecommendationText:
  'For nonpregnant patients 25 years or older with an estimated immediate risk of CIN 3+ of 60% or greater based on history and current results, treatment using an excisional procedure without previous biopsy confirmation is preferred but colposcopy with biopsy is acceptable (BII).'

define CommonAbnormalityRecommendation:
  // TODO: Add J.1 Recommndation text to K.5 above as well.
  case
    when (
      // TODO: Check that >= 25 applies to all 5 Common Abnormality Recommendations
      AgeInYears() >= 25 and
      CommonAbnormalityRecommendationText = '1-year follow-up'
    ) then
      {
        action: CommonAbnormalityRecommendationText,
        text: OneYearSurveillanceRecommendationText + '\n\n' + J1RecommendationText
      }
    when (
      AgeInYears() >= 25 and
      CommonAbnormalityRecommendationText = '3-year follow-up'
    ) then
      {
        action: CommonAbnormalityRecommendationText,
        text: ThreeYearSurveillanceRecommendationText + '\n\n' + J1RecommendationText
      }
    when (
      AgeInYears() >= 25 and
      CommonAbnormalityRecommendationText = '5-year follow-up'
    ) then
      {
        action: CommonAbnormalityRecommendationText,
        text: FiveYearSurveillanceRecommendationText + '\n\n' + J1RecommendationText
      }
    when (
      AgeInYears() >= 25 and
      CommonAbnormalityRecommendationText = 'Colposcopy'
    ) then
      {
        action: CommonAbnormalityRecommendationText,
        text: ColposcopyRecommendationText
      }
    when (
      AgeInYears() >= 25 and AgeInYears() <= 50 and
      CommonAbnormalityRecommendationText = 'Colposcopy/Treatment'
    ) then
      {
        action: CommonAbnormalityRecommendationText,
        text: ColposcopyOrTreatmentRecommendationText + '\n\n' + TreatmentWithPregnancyConcernsRecommendationText
      }
    when (
      AgeInYears() > 50 and
      CommonAbnormalityRecommendationText = 'Colposcopy/Treatment'
    ) then
      {
        action: CommonAbnormalityRecommendationText,
        text: ColposcopyOrTreatmentRecommendationText
      }
    when (
      AgeInYears() >= 25 and AgeInYears() <= 50 and
      CommonAbnormalityRecommendationText = 'Treatment'
    ) then
      {
        action: CommonAbnormalityRecommendationText,
        text: TreatmentRecommendationText + '\n\n' + TreatmentWithPregnancyConcernsRecommendationText
      }
    when (
      AgeInYears() > 50 and
      CommonAbnormalityRecommendationText = 'Treatment'
    ) then
      {
        action: CommonAbnormalityRecommendationText,
        text: TreatmentRecommendationText
      }
    else
      null
  end

// TODO: Add Errata section

//------------------------------------------------------------------------------
// CDS OUTPUTS
//------------------------------------------------------------------------------

define ManagementRecommendation: // NOTE: Should we call this RecommendationText for consistency with other logic paths?
  Coalesce(
    SpecialPopulationRecommendation,
    RareAbnormalityRecommendation,
    CommonAbnormalityRecommendation
  )

define RareAbnormalityPresent:
  RareAbnormalityRecommendation.text is not null or
  SpecialPopulationRecommendation.text is not null

define SpecialPopulation:
  SpecialPopulationRecommendation.text is not null

define CommonAbnormalityPresent:
  CommonAbnormalityRecommendation.text is not null and
  not RareAbnormalityPresent

define ServiceRequestCode:
  null

define ServiceRequestOrderDetail:
  null

define ManagePatientUnder25:
  WhichPopulationMadeTheRecommendation = 5

define ManagePregnantPatient:
  WhichPopulationMadeTheRecommendation = 4

define ManageImmunosuppressedPatient:
  WhichPopulationMadeTheRecommendation = 3

define ManagePatientAfterHysterectomy:
  WhichPopulationMadeTheRecommendation = 2

define ManagePatientOver65:
  WhichPopulationMadeTheRecommendation = 1

define RareCytology:
  not SpecialPopulation and
  WhichRarityMadeTheRecommendation = 1

define ColposcopyException:
  not SpecialPopulation and
  WhichRarityMadeTheRecommendation = 2

define ManagingHistology:
  not SpecialPopulation and
  WhichRarityMadeTheRecommendation = 3

define SurveillanceAfterAbnormalities:
  not SpecialPopulation and
  WhichRarityMadeTheRecommendation = 4

define GeneralScreening:
  CommonAbnormalityPresent and
  WhichTableMadeTheRecommendation = 1

define Surveillance:
  CommonAbnormalityPresent and
  WhichTableMadeTheRecommendation = 2

define ColposcopyResults:
  CommonAbnormalityPresent and
  WhichTableMadeTheRecommendation = 3

define PostColposcopy:
  CommonAbnormalityPresent and
  WhichTableMadeTheRecommendation = 4

define PostTreatment:
  CommonAbnormalityPresent and
  WhichTableMadeTheRecommendation = 5

//------------------------------------------------------------------------------
// ERRORS
//------------------------------------------------------------------------------

define Errors:
  {} union
  Dash.Errors

define ErrorsHaveOccurred:
  Exists(Errors)

define NoErrorsHaveOccurred:
  not ErrorsHaveOccurred
